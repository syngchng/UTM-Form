<!DOCTYPE html>
<!-- saved from url=(0051)https://choi-yoonhyuk.github.io/source_medium_drop/ -->
<html lang="ko"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM ë§í¬ ìƒì„±ê¸° (ë³‘í•©)</title>
<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
body { font-family: sans-serif; padding: 20px; font-size: 14px; }
.dv1, .dv2, .dv3 { margin-bottom: 20px; }
label { display: inline-block; min-width: 120px; margin-bottom: 5px; vertical-align: top; padding-top: 8px; }
input[type="text"] { padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; vertical-align: middle; }
input[type="text"]#final_url { background-color: #eee; }
button { padding: 8px 15px; margin-left: 5px; cursor: pointer; vertical-align: middle; }
fieldset { margin-bottom: 20px; border:1px solid #ccc; padding:10px; }
legend { font-weight: bold; }
.required { color: red; font-weight: bold; }
.hidden { display: none !important; }

/* ë¡œë”© ì¸ë””ì¼€ì´í„° ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
#loadingIndicator {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 1.2em; display: none;
}

/* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ - ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ */
.custom-dropdown-container { display: inline-block; vertical-align: top; }
.custom-dropdown {
    position: relative; display: inline-block; min-width: 200px; width: auto;
    max-width: 300px; border: 1px solid #ccc; border-radius: 4px;
    background-color: #fff; margin-bottom: 10px;
}
.dropdown-selected {
    padding: 8px; cursor: pointer; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; display: block;
}
.dropdown-selected::after {
    content: 'â–¼'; font-size: 0.8em; position: absolute; right: 10px;
    top: 50%; transform: translateY(-50%); color: #888;
}
.dropdown-options {
    position: absolute; top: 100%; left: 0; right: 0;
    background-color: #fff; border: 1px solid #ccc; border-top: none;
    border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto;
    list-style: none; padding: 0; margin: 0; z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dropdown-options li {
    padding: 8px 10px; cursor: pointer; display: flex;
    align-items: center; justify-content: space-between; white-space: nowrap;
}
.dropdown-options li:hover { background-color: #f0f0f0; }
.dropdown-options li .option-content {
    flex-grow: 1; margin-left: 8px; overflow: hidden; text-overflow: ellipsis;
}
.dropdown-options li .icon {
    display: inline-block; width: 10px; height: 10px;
    border-radius: 50%; background-color: #ddd; flex-shrink: 0;
}
.dropdown-options li[data-type="default"] .icon { background-color: #aaa; }
.dropdown-options li[data-type="custom"] .icon { background-color: #6aabff; }
.dropdown-options li .delete-btn {
    background: none; border: none; color: #aaa; cursor: pointer;
    font-size: 1.1em; padding: 0 5px; margin-left: 10px;
    flex-shrink: 0; font-weight: bold;
}
.dropdown-options li .delete-btn:hover { color: #f00; }
.dropdown-options li[data-type="default"] .delete-btn { display: none; }
.dropdown-options .add-option {
    color: #007bff; font-weight: bold; border-top: 1px solid #eee;
}
.add-option-input {
    padding: 5px; border-top: 1px solid #eee; background-color: #f9f9f9;
}
.add-option-input input[type="text"] {
    width: calc(100% - 16px); margin: 0; box-sizing: border-box;
}

/* ì¹œêµ¬ ì½”ë“œì—ì„œ ì¶”ê°€ëœ ì‘ë‹µ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
#responseContainer {
    display: none; /* ì´ˆê¸° ìˆ¨ê¹€ */
    margin-top: 20px;
}
#responseContainer input[type="text"] { /* ë‹¨ì¶• URL ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ì¡°ì • */
    width: calc(100% - 100px); /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
    margin-right: 10px;
}
</style>
</head>
<body data-new-gr-c-s-check-loaded="14.1234.0" data-gr-ext-installed="">
<div id="loadingIndicator" style="display: none;">ì´ë ¥ ë¡œë”© ì¤‘...</div>

<div class="dv1">
<div class="dv2">
    <h1>UTM ë§í¬ ìƒì„±</h1>
    <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
            <thead><tr><th colspan="2">UTM ë„¤ì´ë° ê·œì¹™</th></tr></thead>
            <tbody><tr><td>ê³µí†µ ê·œì¹™</td><td><ul><li>ë„ì–´ì“°ê¸° ê¸ˆì§€</li><li>êµ¬ë¶„ì: ì–¸ë”ìŠ¤ì½”ì–´('_') ë° í•˜ì´í”ˆ('-') ì‚¬ìš©</li><li>ì˜ë¬¸ ë„¤ì´ë°: ì†Œë¬¸ìë§Œ ì‚¬ìš©</li><li>íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€ (&amp;, ?, #, ., /, \ ë“±)</li></ul></td></tr><tr><td>ìº í˜ì¸ ê·œì¹™</td><td><ul><li>êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_ìº í˜ì¸ëª©í‘œ_ê¸°íšì „ì¢…ë¥˜_ìƒí’ˆì¹´í…Œê³ ë¦¬_ê´‘ê³ íƒ€ê²Ÿ_ì†Œì¬íƒ€ì…_ê¸°ê¸°ì¹´í…Œê³ ë¦¬</li><li>ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€</li><li><span class="required">í•„ìˆ˜ í•­ëª©: ë‚ ì§œ, ê´‘ê³  íƒ€ì…, ê¸°ê¸° ì¹´í…Œê³ ë¦¬</span></li></ul></td></tr><tr><td>ì½˜í…ì¸  ê·œì¹™</td><td><ul><li>ëª©í‘œ í–‰ë™, ì¶”ê°€ ê¸°ì… ì‚¬í•­, ë²„ì „ ì¤‘ í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©</li><li>ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'ìœ¼ë¡œ ì²˜ë¦¬</li></ul></td></tr></tbody>
            </table>
    <br>
</div>

<div class="dv3">
    <form id="utmForm">
        <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span> : </label>
        <input type="text" id="page_url" name="page_url" required="" placeholder="https://example.com" oninput="updateFinalURL()"><br><br>

        <label for="source">UTM Source <span class="required">(í•„ìˆ˜)</span> : </label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="source_dropdown">
                <div class="dropdown-selected" id="source_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="source_options_list"><li data-value="newsletter" data-type="default"><span class="icon"></span><span class="option-content">newsletter</span></li><li data-value="google" data-type="default"><span class="icon"></span><span class="option-content">google</span></li><li data-value="gdn" data-type="default"><span class="icon"></span><span class="option-content">gdn</span></li><li data-value="youtube" data-type="default"><span class="icon"></span><span class="option-content">youtube</span></li><li data-value="facebook" data-type="default"><span class="icon"></span><span class="option-content">facebook</span></li><li data-value="instagram" data-type="default"><span class="icon"></span><span class="option-content">instagram</span></li><li data-value="naver" data-type="default"><span class="icon"></span><span class="option-content">naver</span></li><li data-value="kakao" data-type="default"><span class="icon"></span><span class="option-content">kakao</span></li><li data-value="bing" data-type="default"><span class="icon"></span><span class="option-content">bing</span></li><li data-value="yahoo" data-type="default"><span class="icon"></span><span class="option-content">yahoo</span></li><li data-value="karrot" data-type="default"><span class="icon"></span><span class="option-content">karrot</span></li><li data-value="criteo" data-type="default"><span class="icon"></span><span class="option-content">criteo</span></li><li data-value="tiktok" data-type="default"><span class="icon"></span><span class="option-content">tiktok</span></li><li data-value="twitter" data-type="default"><span class="icon"></span><span class="option-content">twitter</span></li><li data-value="pinterest" data-type="default"><span class="icon"></span><span class="option-content">pinterest</span></li><li data-value="linkedin" data-type="default"><span class="icon"></span><span class="option-content">linkedin</span></li><li data-value="taboola" data-type="default"><span class="icon"></span><span class="option-content">taboola</span></li><li data-value="mobon" data-type="default"><span class="icon"></span><span class="option-content">mobon</span></li><li data-value="tistory" data-type="default"><span class="icon"></span><span class="option-content">tistory</span></li><li data-value="toss" data-type="default"><span class="icon"></span><span class="option-content">toss</span></li><li data-value="internal" data-type="default"><span class="icon"></span><span class="option-content">internal</span></li><li class="add-option" id="source_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                <div class="add-option-input hidden" id="source_add_input_container">
                    <input type="text" id="source_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="source" name="utm_source" required="">
        </div>
        <br><br>

        <label for="medium">UTM Medium <span class="required">(í•„ìˆ˜)</span> : </label>
        <div class="custom-dropdown-container">
            <div class="custom-dropdown" id="medium_dropdown">
                <div class="dropdown-selected" id="medium_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                <ul class="dropdown-options hidden" id="medium_options_list"><li data-value="cpc" data-type="default"><span class="icon"></span><span class="option-content">cpc</span></li><li data-value="display" data-type="default"><span class="icon"></span><span class="option-content">display</span></li><li data-value="paid_social" data-type="default"><span class="icon"></span><span class="option-content">paid_social</span></li><li data-value="email" data-type="default"><span class="icon"></span><span class="option-content">email</span></li><li data-value="affiliate" data-type="default"><span class="icon"></span><span class="option-content">affiliate</span></li><li data-value="video" data-type="default"><span class="icon"></span><span class="option-content">video</span></li><li data-value="social" data-type="default"><span class="icon"></span><span class="option-content">social</span></li><li data-value="sms" data-type="default"><span class="icon"></span><span class="option-content">sms</span></li><li data-value="app_push" data-type="default"><span class="icon"></span><span class="option-content">app_push</span></li><li data-value="web_push" data-type="default"><span class="icon"></span><span class="option-content">web_push</span></li><li class="add-option" id="medium_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                <div class="add-option-input hidden" id="medium_add_input_container">
                    <input type="text" id="medium_add_input" placeholder="ì…ë ¥ í›„ Enter">
                </div>
            </div>
            <input type="hidden" id="medium" name="utm_medium" required="">
        </div>
        <br><br>

        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Campaign êµ¬ì„±</legend>
        
            <label for="campaign_date">ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span> :</label>
            <input type="text" id="campaign_date" name="campaign_date_display" placeholder="YYYYMMDD" oninput="updateFinalURL()" required=""><br><br>
            
            <label for="ad_type">ê´‘ê³  íƒ€ì… <span class="required">(í•„ìˆ˜)</span> : </label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_type_dropdown">
                    <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_type_options_list"><li data-value="da" data-type="default"><span class="icon"></span><span class="option-content">da</span></li><li data-value="sa" data-type="default"><span class="icon"></span><span class="option-content">sa</span></li><li class="add-option" id="ad_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="ad_type_add_input_container"><input type="text" id="ad_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_type" name="ad_type_val" required="">
            </div><br><br>
            
            <label for="campaign_goal">ìº í˜ì¸ ëª©í‘œ :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="campaign_goal_dropdown">
                    <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="campaign_goal_options_list"><li data-value="traffic" data-type="default"><span class="icon"></span><span class="option-content">traffic</span></li><li data-value="conv" data-type="default"><span class="icon"></span><span class="option-content">conv</span></li><li data-value="reach" data-type="default"><span class="icon"></span><span class="option-content">reach</span></li><li data-value="view" data-type="default"><span class="icon"></span><span class="option-content">view</span></li><li data-value="tcpa" data-type="default"><span class="icon"></span><span class="option-content">tcpa</span></li><li data-value="click" data-type="default"><span class="icon"></span><span class="option-content">click</span></li><li data-value="cpm" data-type="default"><span class="icon"></span><span class="option-content">cpm</span></li><li data-value="branding" data-type="default"><span class="icon"></span><span class="option-content">branding</span></li><li data-value="purchase" data-type="default"><span class="icon"></span><span class="option-content">purchase</span></li><li data-value="appinstall" data-type="default"><span class="icon"></span><span class="option-content">appinstall</span></li><li class="add-option" id="campaign_goal_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="campaign_goal_add_input_container"><input type="text" id="campaign_goal_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="campaign_goal" name="campaign_goal_val">
            </div><br><br>
            
            <label for="event_type">ê¸°íšì „ ì¢…ë¥˜ :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="event_type_dropdown">
                    <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="event_type_options_list"><li data-value="promotion" data-type="default"><span class="icon"></span><span class="option-content">promotion</span></li><li data-value="pre" data-type="default"><span class="icon"></span><span class="option-content">pre</span></li><li data-value="season" data-type="default"><span class="icon"></span><span class="option-content">season</span></li><li data-value="flash" data-type="default"><span class="icon"></span><span class="option-content">flash</span></li><li data-value="inven" data-type="default"><span class="icon"></span><span class="option-content">inven</span></li><li data-value="anni" data-type="default"><span class="icon"></span><span class="option-content">anni</span></li><li data-value="vip" data-type="default"><span class="icon"></span><span class="option-content">vip</span></li><li data-value="new" data-type="default"><span class="icon"></span><span class="option-content">new</span></li><li data-value="holiday" data-type="default"><span class="icon"></span><span class="option-content">holiday</span></li><li data-value="bundle" data-type="default"><span class="icon"></span><span class="option-content">bundle</span></li><li class="add-option" id="event_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="event_type_add_input_container"><input type="text" id="event_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="event_type" name="event_type_val"> 
            </div><br><br>

            <label for="product_category">ìƒí’ˆ ì¹´í…Œê³ ë¦¬ :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="product_category_dropdown">
                    <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="product_category_options_list"><li data-value="fashion" data-type="default"><span class="icon"></span><span class="option-content">fashion</span></li><li data-value="electronic" data-type="default"><span class="icon"></span><span class="option-content">electronic</span></li><li data-value="beauty" data-type="default"><span class="icon"></span><span class="option-content">beauty</span></li><li data-value="car" data-type="default"><span class="icon"></span><span class="option-content">car</span></li><li data-value="home" data-type="default"><span class="icon"></span><span class="option-content">home</span></li><li data-value="sports" data-type="default"><span class="icon"></span><span class="option-content">sports</span></li><li data-value="food" data-type="default"><span class="icon"></span><span class="option-content">food</span></li><li data-value="books" data-type="default"><span class="icon"></span><span class="option-content">books</span></li><li data-value="game" data-type="default"><span class="icon"></span><span class="option-content">game</span></li><li data-value="office" data-type="default"><span class="icon"></span><span class="option-content">office</span></li><li class="add-option" id="product_category_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="product_category_add_input_container"><input type="text" id="product_category_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="product_category" name="product_category_val"> 
            </div><br><br>

            <label for="ad_target">ê´‘ê³  íƒ€ê²Ÿ :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="ad_target_dropdown">
                    <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="ad_target_options_list"><li data-value="non" data-type="default"><span class="icon"></span><span class="option-content">non</span></li><li data-value="f" data-type="default"><span class="icon"></span><span class="option-content">f</span></li><li data-value="m" data-type="default"><span class="icon"></span><span class="option-content">m</span></li><li data-value="int" data-type="default"><span class="icon"></span><span class="option-content">int</span></li><li data-value="re" data-type="default"><span class="icon"></span><span class="option-content">re</span></li><li data-value="lal" data-type="default"><span class="icon"></span><span class="option-content">lal</span></li><li data-value="kw" data-type="default"><span class="icon"></span><span class="option-content">kw</span></li><li data-value="cus" data-type="default"><span class="icon"></span><span class="option-content">cus</span></li><li data-value="pay" data-type="default"><span class="icon"></span><span class="option-content">pay</span></li><li data-value="rival" data-type="default"><span class="icon"></span><span class="option-content">rival</span></li><li data-value="repres" data-type="default"><span class="icon"></span><span class="option-content">repres</span></li><li data-value="brand" data-type="default"><span class="icon"></span><span class="option-content">brand</span></li><li data-value="model" data-type="default"><span class="icon"></span><span class="option-content">model</span></li><li data-value="normal" data-type="default"><span class="icon"></span><span class="option-content">normal</span></li><li data-value="shopping" data-type="default"><span class="icon"></span><span class="option-content">shopping</span></li><li data-value="core" data-type="default"><span class="icon"></span><span class="option-content">core</span></li><li data-value="prod" data-type="default"><span class="icon"></span><span class="option-content">prod</span></li><li class="add-option" id="ad_target_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="ad_target_add_input_container"><input type="text" id="ad_target_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="ad_target" name="ad_target_val"> 
            </div><br><br>

            <label for="creative_type">ì†Œì¬ íƒ€ì… :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="creative_type_dropdown">
                    <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="creative_type_options_list"><li data-value="img" data-type="default"><span class="icon"></span><span class="option-content">img</span></li><li data-value="video" data-type="default"><span class="icon"></span><span class="option-content">video</span></li><li data-value="banner" data-type="default"><span class="icon"></span><span class="option-content">banner</span></li><li data-value="infographic" data-type="default"><span class="icon"></span><span class="option-content">infographic</span></li><li data-value="slider" data-type="default"><span class="icon"></span><span class="option-content">slider</span></li><li data-value="interactive" data-type="default"><span class="icon"></span><span class="option-content">interactive</span></li><li data-value="audio" data-type="default"><span class="icon"></span><span class="option-content">audio</span></li><li data-value="ani" data-type="default"><span class="icon"></span><span class="option-content">ani</span></li><li class="add-option" id="creative_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="creative_type_add_input_container"><input type="text" id="creative_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="creative_type" name="creative_type_val"> 
            </div><br><br>

            <label for="device_type">ê¸°ê¸° ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span> : </label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="device_type_dropdown">
                    <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="device_type_options_list"><li data-value="mo" data-type="default"><span class="icon"></span><span class="option-content">mo</span></li><li data-value="pc" data-type="default"><span class="icon"></span><span class="option-content">pc</span></li><li data-value="app" data-type="default"><span class="icon"></span><span class="option-content">app</span></li><li class="add-option" id="device_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="device_type_add_input_container"><input type="text" id="device_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="device_type" name="device_type_val" required=""> 
            </div><br><br>
        </fieldset>
    
        <fieldset style="border:1px solid #ccc; padding:10px;">
            <legend>UTM Content êµ¬ì„±</legend>
            <label for="content_action">ëª©í‘œ í–‰ë™ :</label>
            <div class="custom-dropdown-container">
                <div class="custom-dropdown" id="content_action_dropdown">
                    <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                    <ul class="dropdown-options hidden" id="content_action_options_list"><li data-value="click" data-type="default"><span class="icon"></span><span class="option-content">click</span></li><li data-value="download" data-type="default"><span class="icon"></span><span class="option-content">download</span></li><li data-value="purchase" data-type="default"><span class="icon"></span><span class="option-content">purchase</span></li><li data-value="signup" data-type="default"><span class="icon"></span><span class="option-content">signup</span></li><li data-value="register" data-type="default"><span class="icon"></span><span class="option-content">register</span></li><li data-value="submit" data-type="default"><span class="icon"></span><span class="option-content">submit</span></li><li data-value="view" data-type="default"><span class="icon"></span><span class="option-content">view</span></li><li data-value="share" data-type="default"><span class="icon"></span><span class="option-content">share</span></li><li class="add-option" id="content_action_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li></ul>
                    <div class="add-option-input hidden" id="content_action_add_input_container"><input type="text" id="content_action_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                </div><input type="hidden" id="content_action" name="content_action_val"> 
            </div><br><br>
        
            <label for="content_detail">ì¶”ê°€ ê¸°ì… ì‚¬í•­ :</label>
            <input type="text" id="content_detail" name="content_detail_display" placeholder="120X240-vertical" oninput="updateFinalURL()"><br><br> 
            <label for="content_version">ë²„ì „ :</label>
            <input type="text" id="content_version" name="content_version_display" placeholder="v1" oninput="updateFinalURL()"><br><br> 
        </fieldset>

        <label for="utm_term">UTM Term (ì„ íƒ) :</label>
        <input type="text" id="utm_term" name="utm_term" placeholder="shoes" oninput="updateFinalURL()"><br><br>

        <input type="hidden" id="utm_campaign" name="utm_campaign" required="" value="N_N_N_N_N_N_N_N">
        <input type="hidden" id="utm_content" name="utm_content" value="N">

        <label for="final_url">ìµœì¢… URL :</label>
        <input type="text" id="final_url" name="final_url" style="width:100%; font-family:monospace;" readonly=""> 
        <div id="shortUrlContainer"></div>
<button type="submit">ì œì¶œ</button>
    </form>

    <div id="responseContainer">
        <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
        <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
        <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
    </div>

    <div id="historyTableContainer" style="margin-top: 30px;">
        <h2>ìƒì„± ì´ë ¥</h2>
        <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable"><thead><tr><th>ìƒì„± ì¼ì‹œ</th><th>Source</th><th>Medium</th><th>Campaign</th><th>Content</th><th>Term</th><th>ë‹¨ì¶• URL</th><th>ì›ë³¸ URL</th></tr></thead><tbody></tbody></table>
    </div>
</div>
</div>

<script>
// --- ì„¤ì •ê°’ ---
const LS_KEY_PREFIX = 'utmGenerator_standalone_';
const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv';
const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxMo8uZQO-4N_hlqCUhzyQdGMQuYQMEywGDs1H7_U49NnnQLYZVhssl9pvn-F5ZVxUPaQ/exec'; // ì‚¬ìš©ìë‹˜ ê¸°ì¡´ URL
const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook-test/a7943c49-150a-4d3b-a383-4f86557ad15f'; 
const HISTORY_JSON_URL = 'https://raw.githubusercontent.com/choi-yoonhyuk/source_medium_drop/main/n8n-builder.json'; // ìˆ˜ì •ëœ URL

const dropdownBaseIds = [
    'source', 'medium', 'ad_type', 'campaign_goal', 'event_type', 
    'product_category', 'ad_target', 'creative_type', 'device_type', 'content_action'
];

const columnHeaderMap = { // í´ë¼ì´ì–¸íŠ¸ CSV íŒŒì‹±ìš©
    'source': 'source', 'medium': 'medium', 'ad_type': 'utm_campaign_ad_type',
    'campaign_goal': 'utm_campaign_goal', 'event_type': 'utm_campaign_event_type',
    'product_category': 'utm_campaign_product_category', 'ad_target': 'utm_campaign_ad_target',
    'creative_type': 'utm_campaign_creative_type', 'device_type': 'utm_campaign_device_type',
    'content_action': 'utm_content_content_action'
};

// --- ì´ˆê¸°í™” ---
document.addEventListener('DOMContentLoaded', async () => {
    showLoading("ì˜µì…˜ ë° ì´ë ¥ ë¡œë”© ì¤‘...");
    let csvData = null;
    try {
        const response = await fetch(GOOGLE_SHEET_CSV_URL);
        if (!response.ok) throw new Error(`CSV ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
        csvData = await response.text();
        console.log("CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ");

        for (const baseId of dropdownBaseIds) {
            try {
                renderAllOptions(baseId, csvData);
                setupDropdownInteractions(baseId);
            } catch (error) {
                console.error(`Error initializing dropdown for ${baseId}:`, error);
            }
        }
        updateFinalURL(); 
        await renderHistoryTable(); // ì¹œêµ¬ ê¸°ëŠ¥: íˆìŠ¤í† ë¦¬ í…Œì´ë¸” ë Œë”ë§
    } catch (error) {
        console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
        alert("ì´ˆê¸° ë°ì´í„°(ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë˜ëŠ” ì´ë ¥)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
        hideLoading();
    }
});

// === Helper Functions (ì‚¬ìš©ìë‹˜ ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ ë° ì¼ë¶€ ì¹œêµ¬ í•¨ìˆ˜ ì¶”ê°€) ===
function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) { indicator.textContent = message; indicator.style.display = 'flex'; }
}
function hideLoading() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) { indicator.style.display = 'none'; }
}

function createOptionLi(value, displayText, type) {
    const li = document.createElement('li');
    const lowerCaseValue = String(value).toLowerCase(); // KeyëŠ” ì†Œë¬¸ì
    li.dataset.value = lowerCaseValue; 
    li.dataset.type = type;

    const iconSpan = document.createElement('span'); iconSpan.className = 'icon'; li.appendChild(iconSpan);
    const textSpan = document.createElement('span'); textSpan.className = 'option-content'; textSpan.textContent = displayText || value; li.appendChild(textSpan);

    if (type === 'custom') {
        const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; li.appendChild(deleteBtn);
    }
    return li;
}

function renderAllOptions(baseId, csvData) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    if (!optionsList || !addOptionButton) return;

    optionsList.innerHTML = ''; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
    optionsList.appendChild(addOptionButton); // 'ì˜µì…˜ ì¶”ê°€' ë²„íŠ¼ ë‹¤ì‹œ ì¶”ê°€

    const defaultOptions = new Set();
    const targetHeader = columnHeaderMap[baseId];

    if (targetHeader && csvData) {
        try {
            const lines = csvData.split(/\r?\n/);
            if (lines.length > 1) {
                const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));
                const columnIndex = headers.findIndex(header => header === targetHeader);
                if (columnIndex !== -1) {
                    for (let i = 2; i < lines.length; i++) { // í—¤ë”, íƒ€ì… í–‰ ì œì™¸
                        const columns = lines[i].split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                        if (columns.length > columnIndex) {
                            const value = String(columns[columnIndex]).trim();
                            if (value) { defaultOptions.add(value); }
                        }
                    }
                } else { console.warn(`Column '${targetHeader}' not found for '${baseId}'.`); }
            }
        } catch (error) { console.error(`Error parsing CSV for ${baseId}:`, error); }
    } else if (!targetHeader) { console.warn(`No header mapping for '${baseId}'.`); }

    defaultOptions.forEach(value => {
        const li = createOptionLi(value, value, 'default');
        optionsList.insertBefore(li, addOptionButton);
    });

    const storageKey = `${LS_KEY_PREFIX}${baseId}`;
    const customValues = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const existingValues = new Set(Array.from(optionsList.querySelectorAll('li[data-value]')).map(li => li.dataset.value));
    
    customValues.forEach(value => {
        const lowerCaseValue = String(value).toLowerCase();
        if (!existingValues.has(lowerCaseValue)) {
            const li = createOptionLi(value, value, 'custom');
            optionsList.insertBefore(li, addOptionButton);
            existingValues.add(lowerCaseValue);
        }
    });
}

function saveCustomOptionsToStorage(baseId) {
    const optionsList = document.getElementById(`${baseId}_options_list`);
    if (!optionsList) return;
    const storageKey = `${LS_KEY_PREFIX}${baseId}`;
    const customValues = [];
    optionsList.querySelectorAll('li[data-type="custom"]').forEach(li => {
        const contentElement = li.querySelector('.option-content');
        if (contentElement) { customValues.push(contentElement.textContent); } // ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥
    });
    localStorage.setItem(storageKey, JSON.stringify(customValues));
}

function setupDropdownInteractions(baseId) {
    const dropdown = document.getElementById(`${baseId}_dropdown`);
    const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
    const optionsList = document.getElementById(`${baseId}_options_list`);
    const hiddenInput = document.getElementById(baseId); // ì´ IDëŠ” ì‹¤ì œ ê°’ì„ ì €ì¥í•˜ëŠ” hidden input
    const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
    const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
    const addInput = document.getElementById(`${baseId}_add_input`);

    if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) return;

    selectedValueDiv.addEventListener('click', (event) => {
        event.stopPropagation(); closeOtherDropdowns(baseId); optionsList.classList.toggle('hidden'); addInputContainer.classList.add('hidden');
    });

    optionsList.addEventListener('click', (event) => {
        event.stopPropagation(); 
        const targetLi = event.target.closest('li');
        if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
            const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
            if (confirm(`'${textContent}' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                if (hiddenInput.value === targetLi.dataset.value) { 
                    selectedValueDiv.textContent = '-- ì„ íƒí•˜ì„¸ìš” --'; 
                    hiddenInput.value = ''; 
                }
                targetLi.remove(); 
                saveCustomOptionsToStorage(baseId); 
                updateFinalURL();
            }
        } else if (targetLi && targetLi.classList.contains('add-option')) {
            addInputContainer.classList.remove('hidden'); addInput.value = ''; addInput.focus();
        } else if (targetLi && typeof targetLi.dataset.value !== 'undefined') {
            const value = targetLi.dataset.value; // ì†Œë¬¸ì key ê°’
            const text = targetLi.querySelector('.option-content')?.textContent || value; // ì›ë³¸ í‘œì‹œ í…ìŠ¤íŠ¸
            selectedValueDiv.textContent = text; 
            hiddenInput.value = value; // hidden inputì—ëŠ” ì†Œë¬¸ì key ê°’ ì €ì¥
            optionsList.classList.add('hidden'); 
            addInputContainer.classList.add('hidden'); 
            updateFinalURL();
        }
    });

    addInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const originalNewValue = addInput.value.trim(); // ì‚¬ìš©ì ì…ë ¥ ì›ë³¸ ê°’
            const lowerCaseNewValue = originalNewValue.toLowerCase(); // Key ê°’ (ì†Œë¬¸ì)

            if (!originalNewValue) { alert('ì¶”ê°€í•  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (/\s|&|\?|#|\.|\/|\\/.test(originalNewValue)) { alert("ë„ì–´ì“°ê¸° ë° íŠ¹ìˆ˜ë¬¸ì(&, ?, #, ., /, \\)ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            // Key ê°’ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì‚¬ëŠ” ì†Œë¬¸ì ê¸°ì¤€ìœ¼ë¡œ
            if (/[^a-z0-9_\-]/.test(lowerCaseNewValue)) { alert("Key ê°’(ì†Œë¬¸ìë¡œ ë³€í™˜ëœ ê°’)ì€ ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_), í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
            
            let exists = false; 
            optionsList.querySelectorAll('li[data-value]').forEach(li => { if(li.dataset.value === lowerCaseNewValue) exists = true; });
            if (exists) { alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê°’(ì†Œë¬¸ì ë³€í™˜ ê¸°ì¤€)ì…ë‹ˆë‹¤."); return; }

            const newLi = createOptionLi(originalNewValue, originalNewValue, 'custom'); // ì›ë³¸ ê°’ìœ¼ë¡œ li ìƒì„±
            optionsList.insertBefore(newLi, addOptionButton);
            saveCustomOptionsToStorage(baseId);

            const gasWebAppUrl = GOOGLE_APPS_SCRIPT_WEB_APP_URL;
            if (!gasWebAppUrl || gasWebAppUrl.includes('YOUR_DEPLOYED_GAS_WEB_APP_URL')) { // URL í”Œë ˆì´ìŠ¤í™€ë” ì²´í¬ ê°•í™”
                console.warn("GAS Web App URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹œíŠ¸ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
            } else {
                showLoading("ìƒˆ ì˜µì…˜ ì‹œíŠ¸ ì €ì¥ ì¤‘...");
                const dataToSend = { action: 'saveOption', type: baseId, value: originalNewValue }; // ì›ë³¸ ê°’ ì „ì†¡

                fetch(gasWebAppUrl, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ë˜ëŠ” application/json
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) { // HTTP ìƒíƒœ ì½”ë“œê°€ 200-299 ë²”ìœ„ ë°–ì¼ ë•Œ
                        return response.text().then(text => { // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë°›ìœ¼ë ¤ê³  ì‹œë„
                           throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status}): ${text || response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Save new option to sheet success:', data);
                    if (data.status !== 'success') {
                        throw new Error(data.message || 'ì„œë²„ì—ì„œ ì˜µì…˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                    }
                    // alert(data.message); // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì )
                })
                .catch((error) => {
                    console.error('Error saving new option via GAS:', error);
                    alert(`ìƒˆ ì˜µì…˜ì„ ì‹œíŠ¸ì— ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}\n(ì˜µì…˜ì€ í˜„ì¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì„ì‹œ ì €ì¥ë©ë‹ˆë‹¤.)`);
                    // UI ë¡¤ë°±ì€ í•˜ì§€ ì•ŠìŒ. ë¡œì»¬ì—ëŠ” ì´ë¯¸ ì €ì¥ë˜ì—ˆê³ , ì‹œíŠ¸ ì €ì¥ë§Œ ì‹¤íŒ¨í•œ ê²ƒì´ë¯€ë¡œ.
                    // í•„ìš”í•˜ë‹¤ë©´ ë¡¤ë°± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥.
                })
                .finally(() => {
                    hideLoading();
                });
            }
            // UI ì—…ë°ì´íŠ¸ëŠ” GAS í˜¸ì¶œ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ ì¦‰ì‹œ ë°˜ì˜
            selectedValueDiv.textContent = originalNewValue;
            hiddenInput.value = lowerCaseNewValue; // hidden inputì—ëŠ” ì†Œë¬¸ì key ê°’
            addInputContainer.classList.add('hidden');
            optionsList.classList.add('hidden');
            updateFinalURL();
        }
    });
    addInput.addEventListener('blur', () => {
        setTimeout(() => { if (!addInputContainer.contains(document.activeElement)) { addInputContainer.classList.add('hidden'); } }, 150);
    });
}

function closeOtherDropdowns(currentBaseId) {
    dropdownBaseIds.forEach(baseId => { 
        if (baseId !== currentBaseId) { 
            document.getElementById(`${baseId}_options_list`)?.classList.add('hidden'); 
            document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden'); 
        } 
    });
}

document.addEventListener('click', (event) => {
    dropdownBaseIds.forEach(baseId => { 
        const dropdownElement = document.getElementById(`${baseId}_dropdown`); 
        if (dropdownElement && !dropdownElement.contains(event.target)) { 
            document.getElementById(`${baseId}_options_list`)?.classList.add('hidden'); 
            document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden'); 
        } 
    });
});

// === UTM ì¡°í•© ë° URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì¹œêµ¬ ì½”ë“œ ìŠ¤íƒ€ì¼ + ì‚¬ìš©ìë‹˜ ID ì°¸ì¡°) ===
function getValueOrN(elementId) {
    // ì‚¬ìš©ìë‹˜ì˜ ì½”ë“œëŠ” hidden input(ID: baseId)ì— ê°’ì„ ì €ì¥í•˜ë¯€ë¡œ, í•´ë‹¹ ê°’ì„ ì½ë„ë¡ ìˆ˜ì •
    // ì¼ë°˜ input textë„ ìˆìœ¼ë¯€ë¡œ ë¶„ê¸° ì²˜ë¦¬
    const element = document.getElementById(elementId);
    let value = "";
    if (element) {
        if (element.type === 'hidden') { // ë“œë¡­ë‹¤ìš´ì„ í†µí•´ ì„ íƒëœ ê°’
            value = element.value.trim();
        } else { // ì§ì ‘ ì…ë ¥ í•„ë“œ (ì˜ˆ: campaign_date, content_detail, content_version, utm_term)
             value = element.value.trim();
        }
    }
    // ë“œë¡­ë‹¤ìš´ì˜ ê²½ìš°, hidden inputì˜ IDëŠ” baseId (ì˜ˆ: 'source', 'ad_type')
    // ì§ì ‘ ì…ë ¥ í•„ë“œì˜ IDëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì˜ˆ: 'campaign_date_display', 'content_detail_display')
    // updateFinalURLì—ì„œ IDë¥¼ ì •í™•íˆ ë§ì¶°ì¤˜ì•¼ í•¨
    return value === "" || value === "-- ì„ íƒí•˜ì„¸ìš” --" ? "N" : value;
}

function updateFinalURL() {
    const pageUrl = document.getElementById("page_url").value.trim();
    // hidden inputì—ì„œ ì‹¤ì œ ê°’ì„ ê°€ì ¸ì˜´
    const utmSource = getValueOrN("source"); 
    const utmMedium = getValueOrN("medium");

    const campaignDate = getValueOrN("campaign_date"); // ì§ì ‘ ì…ë ¥ í•„ë“œ
    const adType = getValueOrN("ad_type");
    const campaignGoal = getValueOrN("campaign_goal");
    const eventType = getValueOrN("event_type");
    const productCategory = getValueOrN("product_category");
    const adTarget = getValueOrN("ad_target");
    const creativeType = getValueOrN("creative_type");
    const deviceType = getValueOrN("device_type");

    const utmCampaignParts = [
        campaignDate, adType, campaignGoal, eventType, 
        productCategory, adTarget, creativeType, deviceType
    ];
    const utmCampaign = utmCampaignParts.join("_");
    document.getElementById("utm_campaign").value = utmCampaign;

    const contentAction = getValueOrN("content_action");
    const contentDetail = getValueOrN("content_detail"); // ì§ì ‘ ì…ë ¥ í•„ë“œ
    const contentVersion = getValueOrN("content_version"); // ì§ì ‘ ì…ë ¥ í•„ë“œ
    
    const utmContentParts = [contentAction, contentDetail, contentVersion];
    // í•˜ë‚˜ë¼ë„ 'N'ì´ ì•„ë‹ˆë©´ ì¡°í•©, ëª¨ë‘ 'N'ì´ë©´ 'N'
    const utmContent = utmContentParts.every(part => part === "N") ? "N" : utmContentParts.join("_");
    document.getElementById("utm_content").value = utmContent;
    
    const utmTerm = getValueOrN("utm_term"); // ì§ì ‘ ì…ë ¥ í•„ë“œ

    let finalURLGenerated = pageUrl;
    const params = [];
    if (utmSource && utmSource !== "N") params.push(`utm_source=${encodeURIComponent(utmSource)}`);
    if (utmMedium && utmMedium !== "N") params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);
    if (utmCampaign && utmCampaign !== Array(utmCampaignParts.length).fill("N").join("_") ) params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`); // ëª¨ë“  ìš”ì†Œê°€ Nìœ¼ë¡œë§Œ êµ¬ì„±ëœ ìº í˜ì¸ ì œì™¸
    if (utmContent && utmContent !== "N") params.push(`utm_content=${encodeURIComponent(utmContent)}`);
    if (utmTerm && utmTerm !== "N") params.push(`utm_term=${encodeURIComponent(utmTerm)}`);

    if (params.length > 0) {
        finalURLGenerated += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
    }
    document.getElementById("final_url").value = finalURLGenerated;
}

// === ì¹œêµ¬ ê¸°ëŠ¥: íˆìŠ¤í† ë¦¬ ê´€ë ¨ í•¨ìˆ˜ ===
async function fetchHistoryData() {
    try {
        const response = await fetch(HISTORY_JSON_URL);
        if (!response.ok) {
            console.warn('íˆìŠ¤í† ë¦¬ íŒŒì¼ ì—†ìŒ ë˜ëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', response.status);
            return [];
        }
        const data = await response.json();
        if (!Array.isArray(data)) {
            console.warn('íˆìŠ¤í† ë¦¬ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜. ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
            return [];
        }
        return data;
    } catch (error) {
        console.warn('íˆìŠ¤í† ë¦¬ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨(íŒŒì¼ ì—†ìŒ ê°€ëŠ¥):', error);
        return [];
    }
}

async function renderHistoryTable() {
    const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
    if (!tableBody) return;
    tableBody.innerHTML = ''; // ê¸°ì¡´ í–‰ ì´ˆê¸°í™”

    showLoading("ì´ë ¥ ë¡œë”© ì¤‘...");
    const data = await fetchHistoryData();
    hideLoading();

    if (data.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 8; // ì»¬ëŸ¼ ìˆ˜ì— ë§ê²Œ ì¡°ì •
        cell.textContent = 'í‘œì‹œí•  ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
        cell.style.textAlign = 'center';
        return;
    }

    data.forEach(item => {
        const row = tableBody.insertRow(); // ìµœì‹  ë°ì´í„°ê°€ ìœ„ë¡œ ì˜¤ê²Œ í•˜ë ¤ë©´ insertRow(0)
        row.insertCell().textContent = item.created_at || (item.formData ? new Date(item.formData.timestamp || Date.now()).toLocaleString() : new Date().toLocaleString()); // íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬ ê°œì„ 
        row.insertCell().textContent = item.utm_source || item.formData?.utm_source || '';
        row.insertCell().textContent = item.utm_medium || item.formData?.utm_medium || '';
        row.insertCell().textContent = item.utm_campaign || item.formData?.utm_campaign || '';
        row.insertCell().textContent = item.utm_content || item.formData?.utm_content || 'N';
        row.insertCell().textContent = item.utm_term || item.formData?.utm_term || 'N';
        
        const pageUrlCell = row.insertCell();
        const originalPageUrl = item.page_url || item.formData?.page_url || '';
        if (originalPageUrl) {
            const aPage = document.createElement('a');
            aPage.href = originalPageUrl;
            aPage.textContent = originalPageUrl;
            aPage.target = '_blank';
            pageUrlCell.appendChild(aPage);
        } else {
            pageUrlCell.textContent = '';
        }
        pageUrlCell.style.wordBreak = 'break-all';


        const finalUrlCell = row.insertCell();
        const finalUrl = item.final_url || item.formData?.final_url || '';
        if (finalUrl) {
            const aFinal = document.createElement('a');
            aFinal.href = finalUrl;
            aFinal.textContent = finalUrl;
            aFinal.target = '_blank';
            finalUrlCell.appendChild(aFinal);
        } else {
            finalUrlCell.textContent = '';
        }
        finalUrlCell.style.wordBreak = 'break-all';
        
        const shortUrlCell = row.insertCell();
        const shortUrl = item.short_url || ''; // n8n ì‘ë‹µì—ì„œ short_url ì‚¬ìš©
        if (shortUrl) {
            const aShort = document.createElement('a');
aShort.href = shortUrl;
aShort.textContent = shortUrl;
aShort.target = '_blank';
shortUrlCell.appendChild(aShort);
        } else {
            shortUrlCell.textContent = 'N/A';
        }
        shortUrlCell.style.wordBreak = 'break-all';
    });
}

// === ì¹œêµ¬ ê¸°ëŠ¥: í¼ ì œì¶œ ë° n8n ì›¹í›… í˜¸ì¶œ (ì‚¬ìš©ìë‹˜ì˜ í¼ í•¸ë“¤ëŸ¬ ëŒ€ì²´) ===
document.getElementById("utmForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoading("UTM ë§í¬ ìƒì„± ë° ë‹¨ì¶• ì¤‘...");

    // í•„ìˆ˜ í•­ëª© ìµœì¢… ê²€ì¦ (ì‚¬ìš©ìë‹˜ ì½”ë“œì˜ ê²€ì¦ ë¡œì§ ì‚¬ìš©)
    const requiredIdsForSubmit = ["source", "medium", "campaign_date", "ad_type", "device_type"];
    // getValueOrNì€ ì´ë¯¸ ì†Œë¬¸ìí™”ëœ hidden input ê°’ì„ ê°€ì ¸ì˜¤ë¯€ë¡œ ì§ì ‘ ë¹„êµ. campaign_dateëŠ” ì§ì ‘ ì…ë ¥ê°’ì´ë¯€ë¡œ text inputì˜ ê°’ì„ ê°€ì ¸ì™€ì•¼ í•¨.
    const getRawValue = (id) => document.getElementById(id)?.value?.trim() || "";

    if (!getRawValue("page_url")) {
        alert('Page URLì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); hideLoading(); document.getElementById('page_url').focus(); return;
    }
    for (let id of requiredIdsForSubmit) {
        let valueToCheck;
        // campaign_dateëŠ” ì§ì ‘ ì…ë ¥ í•„ë“œ, ë‚˜ë¨¸ì§€ëŠ” hidden input(ë“œë¡­ë‹¤ìš´ ì„ íƒê°’)
        if (id === "campaign_date") valueToCheck = getRawValue("campaign_date"); // campaign_date_display ëŒ€ì‹  campaign_date (ì‹¤ì œ input ID)
        else valueToCheck = getValueOrN(id);
        
        if (!valueToCheck || valueToCheck === "N") {
            const labelElement = document.querySelector(`label[for='${id}']`) || document.getElementById(`${id}_dropdown`)?.previousElementSibling;
            const fieldName = labelElement ? labelElement.textContent.replace(/ \(.+\):/, '').trim() : id;
            alert(`í•„ìˆ˜ í•­ëª© '${fieldName}'ì„(ë¥¼) ì„ íƒ ë˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            hideLoading();
            // ë“œë¡­ë‹¤ìš´ì¸ ê²½ìš° ì—´ì–´ì£¼ê¸° ì‹œë„, ì¼ë°˜ inputì´ë©´ í¬ì»¤ìŠ¤
            if (document.getElementById(`${id}_dropdown`)) document.getElementById(`${id}_selected_value`)?.click();
            else document.getElementById(id)?.focus();
            return;
        }
    }
    
    updateFinalURL(); // ìµœì¢… URL ë° ìˆ¨ê²¨ì§„ í•„ë“œ ê°’ ìµœì¢… ì—…ë°ì´íŠ¸

    const formDataForN8n = {
        page_url: document.getElementById('page_url').value,
        utm_source: document.getElementById('source').value,
        utm_medium: document.getElementById('medium').value,
        utm_campaign: document.getElementById('utm_campaign').value,
        utm_content: document.getElementById('utm_content').value,
        utm_term: document.getElementById('utm_term').value,
        final_url: document.getElementById('final_url').value,
        timestamp: new Date().toISOString() // n8nì—ì„œ ìƒì„±ì¼ì‹œë¡œ í™œìš© ê°€ëŠ¥
    };

    console.log("Submitting Form Data to n8n:", formDataForN8n);

    try {
        const n8nUrl = N8N_WEBHOOK_URL;
        if (!n8nUrl || n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
             // ë¡œì»¬ n8n URLì´ê³  í˜„ì¬ í˜ì´ì§€ê°€ httpsë©´ ê²½ê³  (í˜¼í•© ì½˜í…ì¸ ). ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ê³µê°œ n8n URL ì‚¬ìš© í•„ìš”.
            if (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
                 alert("ê²½ê³ : í˜„ì¬ í˜ì´ì§€ëŠ” HTTPSì´ë‚˜ n8n ì›¹í›…ì€ HTTP ë¡œì»¬í˜¸ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì •ìƒ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n(í˜¼í•© ì½˜í…ì¸  ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥)\n\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥ ì €ì¥ ì•ˆë¨):\n" + formDataForN8n.final_url);
            } else {
                 alert("n8n ì›¹í›… URLì´ ë¡œì»¬í˜¸ìŠ¤íŠ¸ì´ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥ ì €ì¥ ì•ˆë¨):\n" + formDataForN8n.final_url);
            }
            // n8n í˜¸ì¶œ ì—†ì´ ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬ (ì˜ˆì‹œ)
            document.getElementById("responseContainer").style.display = "none"; // ë‹¨ì¶• URL ìˆ¨ê¹€
            // addHistoryRowLocal(formDataForN8n); // ë¡œì»¬ íˆìŠ¤í† ë¦¬ ì‚¬ìš© ì‹œ
            hideLoading();
            return; 
        }


        const res = await fetch(n8nUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formDataForN8n) // formDataForN8n ì‚¬ìš©
        });

        if (!res.ok) {
            // ì„œë²„ ì‘ë‹µì´ ìˆì§€ë§Œ HTTP ì—ëŸ¬ ìƒíƒœì¼ ë•Œ (ì˜ˆ: 4xx, 5xx)
            const errorText = await res.text(); // ì—ëŸ¬ ë³¸ë¬¸ì„ í…ìŠ¤íŠ¸ë¡œ ì½ì–´ë³´ë ¤ ì‹œë„
            throw new Error(`n8n ì›¹í›… ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText || res.statusText}`);
        }
        
        const result = await res.json(); // ì„±ê³µì ì¸ ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±

        if (result.short_url) {
            document.getElementById("shortUrlInput").value = result.short_url;
            document.getElementById("responseContainer").style.display = "block";
            await renderHistoryTable(); // n8n ì²˜ë¦¬ í›„ íˆìŠ¤í† ë¦¬ ë‹¤ì‹œ ë¡œë“œ
            alert("UTM ë§í¬ ìƒì„± ë° ë‹¨ì¶• ì™„ë£Œ!\nìµœì¢… URL: " + formDataForN8n.final_url + "\në‹¨ì¶• URL: " + result.short_url);
        } else {
            alert("ë‹¨ì¶• URLì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš° ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.\nìµœì¢… URL: " + formDataForN8n.final_url);
            document.getElementById("responseContainer").style.display = "none";
        }
    } catch (err) {
        console.error("n8n ì „ì†¡ ì˜¤ë¥˜:", err);
        alert(`ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}\n(UTM ë§í¬ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ë‹¨ì¶• ë° ì´ë ¥ ì €ì¥ì€ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: ${formDataForN8n.final_url}`);
        document.getElementById("responseContainer").style.display = "none";
    } finally {
        hideLoading();
    }
});

// ì¹œêµ¬ ê¸°ëŠ¥: ë³µì‚¬ ê¸°ëŠ¥
function copyLink() {
    const input = document.getElementById("shortUrlInput");
    if (!input || !input.value) {
        alert("ë³µì‚¬í•  ë‹¨ì¶• URLì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices

    try {
        const successful = document.execCommand("copy");
        if (successful) {
            alert("âœ… ë‹¨ì¶• URL ë³µì‚¬ ì™„ë£Œ!");
        } else {
            alert("âŒ ë‹¨ì¶• URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
        }
    } catch (err) {
        alert("âŒ ë³µì‚¬ ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        console.error('Copy error', err);
    }
    // ì„ íƒ í•´ì œ
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
    } else if (document.selection) {
      document.selection.empty();
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ í˜¸ì¶œ (DOMContentLoadedì—ì„œ ì´ë¯¸ updateFinalURL í˜¸ì¶œ)
// ëª¨ë“  í•„ë“œì— oninput="updateFinalURL()"ê°€ ìˆìœ¼ë¯€ë¡œ ì´ˆê¸° ë¡œë“œ ì™¸ì—ëŠ” ìë™ ì—…ë°ì´íŠ¸ë¨.
// updateFinalURL(); 
</script>

</body><grammarly-desktop-integration data-grammarly-shadow-root="true"><template shadowrootmode="open"><style>
      div.grammarly-desktop-integration {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select:none;
        user-select:none;
      }

      div.grammarly-desktop-integration:before {
        content: attr(data-content);
      }
    </style><div aria-label="grammarly-integration" role="group" tabindex="-1" class="grammarly-desktop-integration" data-content="{&quot;mode&quot;:&quot;full&quot;,&quot;isActive&quot;:true,&quot;isUserDisabled&quot;:false}"></div></template></grammarly-desktop-integration></html>
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM ë§í¬ ìƒì„±ê¸°</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: sans-serif;
            padding: 20px;
            font-size: 14px;
        }

        .dv1,
        .dv2,
        .dv3 {
            margin-bottom: 20px;
        }

        .button-container {
            margin-bottom: 20px;
            position: relative;
            width: fit-content;
            display: inline-block;
            margin: 0 0 20px 50px;
        }

        .button-container button {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            background-color: #fb0e69;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .button-container button:hover {
            background-color: #f81e72;
        }

        label {
            display: inline-block;
            min-width: 120px;
            margin-bottom: 5px;
            vertical-align: top;
            padding-top: 8px;
        }

        input[type="text"] {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 200px;
            vertical-align: middle;
        }

        input[type="text"]#final_url {
            background-color: #eee;
        }

        button {
            padding: 8px 15px;
            margin-left: 5px;
            cursor: pointer;
            vertical-align: middle;
        }

        fieldset {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        legend {
            font-weight: bold;
        }

        .required {
            color: red;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            display: none;
        }

        .custom-dropdown-container {
            display: inline-block;
            vertical-align: top;
        }

        .custom-dropdown {
            position: relative;
            display: inline-block;
            min-width: 200px;
            width: auto;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            margin-bottom: 10px;
        }

        .dropdown-selected {
            padding: 8px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .dropdown-selected::after {
            content: 'â–¼';
            font-size: 0.8em;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dropdown-options li {
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
        }

        .dropdown-options li:hover {
            background-color: #f0f0f0;
        }

        .dropdown-options li .option-content {
            flex-grow: 1;
            margin-left: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-options li .icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
            flex-shrink: 0;
        }

        .dropdown-options li[data-type="default"] .icon {
            background-color: #aaa;
        }

        .dropdown-options li[data-type="custom"] .icon {
            background-color: #6aabff;
        }

        .dropdown-options li .delete-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 5px;
            margin-left: 10px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .dropdown-options li .delete-btn:hover {
            color: #f00;
        }

        .dropdown-options li[data-type="default"] .delete-btn {
            display: none;
        }

        .dropdown-options .add-option {
            color: #007bff;
            font-weight: bold;
            border-top: 1px solid #eee;
        }

        .add-option-input {
            padding: 5px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }

        .add-option-input input[type="text"] {
            width: calc(100% - 16px);
            margin: 0;
            box-sizing: border-box;
        }

        #responseContainer {
            display: none;
            margin-top: 20px;
        }

        #responseContainer input[type="text"] {
            width: calc(100% - 100px);
            margin-right: 10px;
        }
    </style>
</head>

<body data-new-gr-c-s-check-loaded="14.1235.0" data-gr-ext-installed="">
    <div id="loadingIndicator" style="display: none;">ì´ë ¥ ë¡œë”© ì¤‘...</div>

    <div class="dv1">
        <div class="dv2">

            <h1 style="display: inline-block;">UTM ë§í¬ ìƒì„±ê¸°</h1>
            <div class="button-container">
                <button onclick="location.href='https://syngchng.github.io/UTM-Param-Value-List/';">UTM ì˜µì…˜ ëª©ë¡</button>
                <button onclick="location.href='https://syngchng.github.io/UTM-History/';">UTM ìƒì„± ì´ë ¥</button>
            </div>
            <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th colspan="2">UTM ë„¤ì´ë° ê·œì¹™</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ê³µí†µ ê·œì¹™</td>
                        <td>
                            <ul>
                                <li>ë„ì–´ì“°ê¸° ê¸ˆì§€</li>
                                <li>êµ¬ë¶„ì: ì–¸ë”ìŠ¤ì½”ì–´('_') ë° í•˜ì´í”ˆ('-') ì‚¬ìš©</li>
                                <li>ì˜ë¬¸ ë„¤ì´ë°: ì†Œë¬¸ìë§Œ ì‚¬ìš©</li>
                                <li>íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€ (&amp;, ?, #, ., /, \ ë“±)</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>ìº í˜ì¸ ê·œì¹™</td>
                        <td>
                            <ul>
                                <li>êµ¬ì„±: ë‚ ì§œ_ê´‘ê³ íƒ€ì…_ìº í˜ì¸ëª©í‘œ_ê¸°íšì „ì¢…ë¥˜_ìƒí’ˆì¹´í…Œê³ ë¦¬_ê´‘ê³ íƒ€ê²Ÿ_ì†Œì¬íƒ€ì…_ê¸°ê¸°ì¹´í…Œê³ ë¦¬</li>
                                <li>ì—†ìœ¼ë©´ 'N'ìœ¼ë¡œ ì±„ì›€</li>
                                <li><span class="required">í•„ìˆ˜ í•­ëª©: ë‚ ì§œ, ê´‘ê³  íƒ€ì…, ê¸°ê¸° ì¹´í…Œê³ ë¦¬</span></li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>ì½˜í…ì¸  ê·œì¹™</td>
                        <td>
                            <ul>
                                <li>ëª©í‘œí–‰ë™, ì¶”ê°€ê¸°ì…ì‚¬í•­, ë²„ì „ ì¤‘ í•˜ë‚˜ë¼ë„ ì…ë ¥ë˜ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì¡°í•©</li>
                                <li>ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ 'N'ìœ¼ë¡œ ì²˜ë¦¬</li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
            <br>
        </div>

        <div class="dv3">
            <form id="utmForm" action="https://entrench-consulting.app.n8n.cloud/webhook/utm-form" method="POST">
                <label for="page_url">Page URL <span class="required">(í•„ìˆ˜)</span> :</label>
                <input type="text" id="page_url" name="page_url_form" required="" placeholder="https://example.com"
                    oninput="updateFinalURL()"><br><br>

                <label for="source">UTM Source <span class="required">(í•„ìˆ˜)</span> :</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="source_dropdown">
                        <div class="dropdown-selected" id="source_selected_value" tabindex="0">google</div>
                        <ul class="dropdown-options hidden" id="source_options_list">
                            <li data-value="newsletter" data-type="default"><span class="icon"></span><span
                                    class="option-content">newsletter</span></li>
                            <li data-value="google" data-type="default"><span class="icon"></span><span
                                    class="option-content">google</span></li>
                            <li data-value="gdn" data-type="default"><span class="icon"></span><span
                                    class="option-content">gdn</span></li>
                            <li data-value="youtube" data-type="default"><span class="icon"></span><span
                                    class="option-content">youtube</span></li>
                            <li data-value="facebook" data-type="default"><span class="icon"></span><span
                                    class="option-content">facebook</span></li>
                            <li data-value="instagram" data-type="default"><span class="icon"></span><span
                                    class="option-content">instagram</span></li>
                            <li data-value="naver" data-type="default"><span class="icon"></span><span
                                    class="option-content">naver</span></li>
                            <li data-value="kakao" data-type="default"><span class="icon"></span><span
                                    class="option-content">kakao</span></li>
                            <li data-value="bing" data-type="default"><span class="icon"></span><span
                                    class="option-content">bing</span></li>
                            <li data-value="yahoo" data-type="default"><span class="icon"></span><span
                                    class="option-content">yahoo</span></li>
                            <li data-value="karrot" data-type="default"><span class="icon"></span><span
                                    class="option-content">karrot</span></li>
                            <li data-value="criteo" data-type="default"><span class="icon"></span><span
                                    class="option-content">criteo</span></li>
                            <li data-value="tiktok" data-type="default"><span class="icon"></span><span
                                    class="option-content">tiktok</span></li>
                            <li data-value="twitter" data-type="default"><span class="icon"></span><span
                                    class="option-content">twitter</span></li>
                            <li data-value="pinterest" data-type="default"><span class="icon"></span><span
                                    class="option-content">pinterest</span></li>
                            <li data-value="linkedin" data-type="default"><span class="icon"></span><span
                                    class="option-content">linkedin</span></li>
                            <li data-value="taboola" data-type="default"><span class="icon"></span><span
                                    class="option-content">taboola</span></li>
                            <li data-value="mobon" data-type="default"><span class="icon"></span><span
                                    class="option-content">mobon</span></li>
                            <li data-value="tistory" data-type="default"><span class="icon"></span><span
                                    class="option-content">tistory</span></li>
                            <li data-value="toss" data-type="default"><span class="icon"></span><span
                                    class="option-content">toss</span></li>
                            <li data-value="internal" data-type="default"><span class="icon"></span><span
                                    class="option-content">internal</span></li>
                            <li data-value="{{ $(&#39;code2&#39;).item.body.source }}" data-type="default"><span
                                    class="icon"></span><span class="option-content">{{ $('Code2').item.body.source
                                    }}</span></li>
                            <li class="add-option" id="source_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                        </ul>
                        <div class="add-option-input hidden" id="source_add_input_container">
                            <input type="text" id="source_add_input" placeholder="ì…ë ¥ í›„ Enter">
                        </div>
                    </div>
                    <input type="hidden" id="source" name="source_hidden" required="" value="google">
                </div>
                <br><br>

                <label for="medium">UTM Medium <span class="required">(í•„ìˆ˜)</span> :</label>
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="medium_dropdown">
                        <div class="dropdown-selected" id="medium_selected_value" tabindex="0">cpc</div>
                        <ul class="dropdown-options hidden" id="medium_options_list">
                            <li data-value="cpc" data-type="default"><span class="icon"></span><span
                                    class="option-content">cpc</span></li>
                            <li data-value="display" data-type="default"><span class="icon"></span><span
                                    class="option-content">display</span></li>
                            <li data-value="paid_social" data-type="default"><span class="icon"></span><span
                                    class="option-content">paid_social</span></li>
                            <li data-value="email" data-type="default"><span class="icon"></span><span
                                    class="option-content">email</span></li>
                            <li data-value="affiliate" data-type="default"><span class="icon"></span><span
                                    class="option-content">affiliate</span></li>
                            <li data-value="video" data-type="default"><span class="icon"></span><span
                                    class="option-content">video</span></li>
                            <li data-value="social" data-type="default"><span class="icon"></span><span
                                    class="option-content">social</span></li>
                            <li data-value="sms" data-type="default"><span class="icon"></span><span
                                    class="option-content">sms</span></li>
                            <li data-value="app_push" data-type="default"><span class="icon"></span><span
                                    class="option-content">app_push</span></li>
                            <li data-value="web_push" data-type="default"><span class="icon"></span><span
                                    class="option-content">web_push</span></li>
                            <li data-value="{{ $(&#39;code2&#39;).item.body.medium }}" data-type="default"><span
                                    class="icon"></span><span class="option-content">{{ $('Code2').item.body.medium
                                    }}</span></li>
                            <li class="add-option" id="medium_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                        </ul>
                        <div class="add-option-input hidden" id="medium_add_input_container">
                            <input type="text" id="medium_add_input" placeholder="ì…ë ¥ í›„ Enter">
                        </div>
                    </div>
                    <input type="hidden" id="medium" name="medium_hidden" required="" value="cpc">
                </div>
                <br><br>

                <fieldset style="border:1px solid #ccc; padding:10px;">
                    <legend>UTM Campaign êµ¬ì„±</legend>
                    <label for="campaign_date">ë‚ ì§œ <span class="required">(í•„ìˆ˜)</span> :</label>
                    <input type="text" id="campaign_date" name="campaign_date_form" placeholder="YYYYMMDD"
                        oninput="updateFinalURL()" required=""><br><br>
                    <label for="ad_type">ê´‘ê³  íƒ€ì… <span class="required">(í•„ìˆ˜)</span> :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="ad_type_dropdown">
                            <div class="dropdown-selected" id="ad_type_selected_value" tabindex="0">da</div>
                            <ul class="dropdown-options hidden" id="ad_type_options_list">
                                <li data-value="da" data-type="default"><span class="icon"></span><span
                                        class="option-content">da</span></li>
                                <li data-value="sa" data-type="default"><span class="icon"></span><span
                                        class="option-content">sa</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.ad_type }}" data-type="default"><span
                                        class="icon"></span><span class="option-content">{{ $('Code2').item.body.ad_type
                                        }}</span></li>
                                <li class="add-option" id="ad_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="ad_type_add_input_container"><input type="text"
                                    id="ad_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="ad_type" name="ad_type_hidden" required="" value="da">
                    </div><br><br>
                    <label for="campaign_goal">ìº í˜ì¸ ëª©í‘œ :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="campaign_goal_dropdown">
                            <div class="dropdown-selected" id="campaign_goal_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --
                            </div>
                            <ul class="dropdown-options hidden" id="campaign_goal_options_list">
                                <li data-value="traffic" data-type="default"><span class="icon"></span><span
                                        class="option-content">traffic</span></li>
                                <li data-value="conv" data-type="default"><span class="icon"></span><span
                                        class="option-content">conv</span></li>
                                <li data-value="reach" data-type="default"><span class="icon"></span><span
                                        class="option-content">reach</span></li>
                                <li data-value="view" data-type="default"><span class="icon"></span><span
                                        class="option-content">view</span></li>
                                <li data-value="tcpa" data-type="default"><span class="icon"></span><span
                                        class="option-content">tcpa</span></li>
                                <li data-value="click" data-type="default"><span class="icon"></span><span
                                        class="option-content">click</span></li>
                                <li data-value="cpm" data-type="default"><span class="icon"></span><span
                                        class="option-content">cpm</span></li>
                                <li data-value="branding" data-type="default"><span class="icon"></span><span
                                        class="option-content">branding</span></li>
                                <li data-value="purchase" data-type="default"><span class="icon"></span><span
                                        class="option-content">purchase</span></li>
                                <li data-value="appinstall" data-type="default"><span class="icon"></span><span
                                        class="option-content">appinstall</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.campaign_goal }}" data-type="default">
                                    <span class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.campaign_goal }}</span></li>
                                <li class="add-option" id="campaign_goal_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="campaign_goal_add_input_container"><input
                                    type="text" id="campaign_goal_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="campaign_goal" name="campaign_goal_hidden">
                    </div><br><br>
                    <label for="event_type">ê¸°íšì „ ì¢…ë¥˜ :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="event_type_dropdown">
                            <div class="dropdown-selected" id="event_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                            <ul class="dropdown-options hidden" id="event_type_options_list">
                                <li data-value="promotion" data-type="default"><span class="icon"></span><span
                                        class="option-content">promotion</span></li>
                                <li data-value="pre" data-type="default"><span class="icon"></span><span
                                        class="option-content">pre</span></li>
                                <li data-value="season" data-type="default"><span class="icon"></span><span
                                        class="option-content">season</span></li>
                                <li data-value="flash" data-type="default"><span class="icon"></span><span
                                        class="option-content">flash</span></li>
                                <li data-value="inven" data-type="default"><span class="icon"></span><span
                                        class="option-content">inven</span></li>
                                <li data-value="anni" data-type="default"><span class="icon"></span><span
                                        class="option-content">anni</span></li>
                                <li data-value="vip" data-type="default"><span class="icon"></span><span
                                        class="option-content">vip</span></li>
                                <li data-value="new" data-type="default"><span class="icon"></span><span
                                        class="option-content">new</span></li>
                                <li data-value="holiday" data-type="default"><span class="icon"></span><span
                                        class="option-content">holiday</span></li>
                                <li data-value="bundle" data-type="default"><span class="icon"></span><span
                                        class="option-content">bundle</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.event_type }}" data-type="default"><span
                                        class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.event_type }}</span></li>
                                <li class="add-option" id="event_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="event_type_add_input_container"><input type="text"
                                    id="event_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="event_type" name="event_type_hidden">
                    </div><br><br>
                    <label for="product_category">ìƒí’ˆ ì¹´í…Œê³ ë¦¬ :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="product_category_dropdown">
                            <div class="dropdown-selected" id="product_category_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --
                            </div>
                            <ul class="dropdown-options hidden" id="product_category_options_list">
                                <li data-value="fashion" data-type="default"><span class="icon"></span><span
                                        class="option-content">fashion</span></li>
                                <li data-value="electronic" data-type="default"><span class="icon"></span><span
                                        class="option-content">electronic</span></li>
                                <li data-value="beauty" data-type="default"><span class="icon"></span><span
                                        class="option-content">beauty</span></li>
                                <li data-value="car" data-type="default"><span class="icon"></span><span
                                        class="option-content">car</span></li>
                                <li data-value="home" data-type="default"><span class="icon"></span><span
                                        class="option-content">home</span></li>
                                <li data-value="sports" data-type="default"><span class="icon"></span><span
                                        class="option-content">sports</span></li>
                                <li data-value="food" data-type="default"><span class="icon"></span><span
                                        class="option-content">food</span></li>
                                <li data-value="books" data-type="default"><span class="icon"></span><span
                                        class="option-content">books</span></li>
                                <li data-value="game" data-type="default"><span class="icon"></span><span
                                        class="option-content">game</span></li>
                                <li data-value="office" data-type="default"><span class="icon"></span><span
                                        class="option-content">office</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.product_category }}"
                                    data-type="default"><span class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.product_category }}</span></li>
                                <li class="add-option" id="product_category_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="product_category_add_input_container"><input
                                    type="text" id="product_category_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="product_category" name="product_category_hidden">
                    </div><br><br>
                    <label for="ad_target">ê´‘ê³  íƒ€ê²Ÿ :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="ad_target_dropdown">
                            <div class="dropdown-selected" id="ad_target_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --</div>
                            <ul class="dropdown-options hidden" id="ad_target_options_list">
                                <li data-value="non" data-type="default"><span class="icon"></span><span
                                        class="option-content">non</span></li>
                                <li data-value="f" data-type="default"><span class="icon"></span><span
                                        class="option-content">f</span></li>
                                <li data-value="m" data-type="default"><span class="icon"></span><span
                                        class="option-content">m</span></li>
                                <li data-value="int" data-type="default"><span class="icon"></span><span
                                        class="option-content">int</span></li>
                                <li data-value="re" data-type="default"><span class="icon"></span><span
                                        class="option-content">re</span></li>
                                <li data-value="lal" data-type="default"><span class="icon"></span><span
                                        class="option-content">lal</span></li>
                                <li data-value="kw" data-type="default"><span class="icon"></span><span
                                        class="option-content">kw</span></li>
                                <li data-value="cus" data-type="default"><span class="icon"></span><span
                                        class="option-content">cus</span></li>
                                <li data-value="pay" data-type="default"><span class="icon"></span><span
                                        class="option-content">pay</span></li>
                                <li data-value="rival" data-type="default"><span class="icon"></span><span
                                        class="option-content">rival</span></li>
                                <li data-value="repres" data-type="default"><span class="icon"></span><span
                                        class="option-content">repres</span></li>
                                <li data-value="brand" data-type="default"><span class="icon"></span><span
                                        class="option-content">brand</span></li>
                                <li data-value="model" data-type="default"><span class="icon"></span><span
                                        class="option-content">model</span></li>
                                <li data-value="normal" data-type="default"><span class="icon"></span><span
                                        class="option-content">normal</span></li>
                                <li data-value="shopping" data-type="default"><span class="icon"></span><span
                                        class="option-content">shopping</span></li>
                                <li data-value="core" data-type="default"><span class="icon"></span><span
                                        class="option-content">core</span></li>
                                <li data-value="prod" data-type="default"><span class="icon"></span><span
                                        class="option-content">prod</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.ad_target }}" data-type="default"><span
                                        class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.ad_target }}</span></li>
                                <li class="add-option" id="ad_target_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="ad_target_add_input_container"><input type="text"
                                    id="ad_target_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="ad_target" name="ad_target_hidden">
                    </div><br><br>
                    <label for="creative_type">ì†Œì¬ íƒ€ì… :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="creative_type_dropdown">
                            <div class="dropdown-selected" id="creative_type_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --
                            </div>
                            <ul class="dropdown-options hidden" id="creative_type_options_list">
                                <li data-value="img" data-type="default"><span class="icon"></span><span
                                        class="option-content">img</span></li>
                                <li data-value="video" data-type="default"><span class="icon"></span><span
                                        class="option-content">video</span></li>
                                <li data-value="banner" data-type="default"><span class="icon"></span><span
                                        class="option-content">banner</span></li>
                                <li data-value="infographic" data-type="default"><span class="icon"></span><span
                                        class="option-content">infographic</span></li>
                                <li data-value="slider" data-type="default"><span class="icon"></span><span
                                        class="option-content">slider</span></li>
                                <li data-value="interactive" data-type="default"><span class="icon"></span><span
                                        class="option-content">interactive</span></li>
                                <li data-value="audio" data-type="default"><span class="icon"></span><span
                                        class="option-content">audio</span></li>
                                <li data-value="ani" data-type="default"><span class="icon"></span><span
                                        class="option-content">ani</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.creative_type }}" data-type="default">
                                    <span class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.creative_type }}</span></li>
                                <li class="add-option" id="creative_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="creative_type_add_input_container"><input
                                    type="text" id="creative_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="creative_type" name="creative_type_hidden">
                    </div><br><br>
                    <label for="device_type">ê¸°ê¸° ì¹´í…Œê³ ë¦¬ <span class="required">(í•„ìˆ˜)</span> :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="device_type_dropdown">
                            <div class="dropdown-selected" id="device_type_selected_value" tabindex="0">mo</div>
                            <ul class="dropdown-options hidden" id="device_type_options_list">
                                <li data-value="mo" data-type="default"><span class="icon"></span><span
                                        class="option-content">mo</span></li>
                                <li data-value="pc" data-type="default"><span class="icon"></span><span
                                        class="option-content">pc</span></li>
                                <li data-value="app" data-type="default"><span class="icon"></span><span
                                        class="option-content">app</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.device_type }}" data-type="default">
                                    <span class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.device_type }}</span></li>
                                <li class="add-option" id="device_type_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="device_type_add_input_container"><input type="text"
                                    id="device_type_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="device_type" name="device_type_hidden" required="" value="mo">
                    </div><br><br>
                </fieldset>

                <fieldset style="border:1px solid #ccc; padding:10px;">
                    <legend>UTM Content êµ¬ì„±</legend>
                    <label for="content_action">ëª©í‘œ í–‰ë™ :</label>
                    <div class="custom-dropdown-container">
                        <div class="custom-dropdown" id="content_action_dropdown">
                            <div class="dropdown-selected" id="content_action_selected_value" tabindex="0">-- ì„ íƒí•˜ì„¸ìš” --
                            </div>
                            <ul class="dropdown-options hidden" id="content_action_options_list">
                                <li data-value="click" data-type="default"><span class="icon"></span><span
                                        class="option-content">click</span></li>
                                <li data-value="download" data-type="default"><span class="icon"></span><span
                                        class="option-content">download</span></li>
                                <li data-value="purchase" data-type="default"><span class="icon"></span><span
                                        class="option-content">purchase</span></li>
                                <li data-value="signup" data-type="default"><span class="icon"></span><span
                                        class="option-content">signup</span></li>
                                <li data-value="register" data-type="default"><span class="icon"></span><span
                                        class="option-content">register</span></li>
                                <li data-value="submit" data-type="default"><span class="icon"></span><span
                                        class="option-content">submit</span></li>
                                <li data-value="view" data-type="default"><span class="icon"></span><span
                                        class="option-content">view</span></li>
                                <li data-value="share" data-type="default"><span class="icon"></span><span
                                        class="option-content">share</span></li>
                                <li data-value="{{ $(&#39;code2&#39;).item.body.content_action }}" data-type="default">
                                    <span class="icon"></span><span class="option-content">{{
                                        $('Code2').item.body.content_action }}</span></li>
                                <li class="add-option" id="content_action_add_option_button">+ ì˜µì…˜ ì¶”ê°€</li>
                            </ul>
                            <div class="add-option-input hidden" id="content_action_add_input_container"><input
                                    type="text" id="content_action_add_input" placeholder="ì…ë ¥ í›„ Enter"></div>
                        </div><input type="hidden" id="content_action" name="content_action_hidden">
                    </div><br><br>
                    <label for="content_detail">ì¶”ê°€ ê¸°ì… ì‚¬í•­ :</label>
                    <input type="text" id="content_detail" name="content_detail_form" placeholder="120X240-vertical"
                        oninput="updateFinalURL()"><br><br>
                    <label for="content_version">ë²„ì „ :</label>
                    <input type="text" id="content_version" name="content_version_form" placeholder="v1"
                        oninput="updateFinalURL()"><br><br>
                </fieldset>

                <label for="utm_term">Term (ì„ íƒ) :</label>
                <input type="text" id="utm_term" name="utm_term_form" placeholder="shoes"
                    oninput="updateFinalURL()"><br><br>

                <input type="hidden" id="utm_campaign" name="utm_campaign_combined" required=""
                    value="20250515_da_N_N_N_N_N_mo">
                <input type="hidden" id="utm_content" name="utm_content_combined" value="N">

                <label for="final_url">ìµœì¢… URL :</label>
                <input type="text" id="final_url" name="final_url_display" readonly=""
                    style="width: 80%;font-family:monospace;display: inline-block;">
                <button type="submit">ì œì¶œ</button>
                <div id="shortUrlContainer"></div>
            </form>

            <div id="responseContainer">
                <label for="shortUrlInput">ğŸ”— ë‹¨ì¶• URL:</label>
                <input type="text" id="shortUrlInput" readonly="" style="font-family:monospace;">
                <button type="button" onclick="copyLink()">ğŸ“‹ ë³µì‚¬</button>
            </div>

            <div id="historyTableContainer" style="margin-top: 30px;">
                <h2>ìƒì„± ì´ë ¥</h2>
                <table border="1" cellpadding="5" style="width:100%; border-collapse: collapse;" id="historyTable">
                    <thead>
                        <tr>
                            <th>ìƒì„± ì¼ì‹œ</th>
                            <th>Source</th>
                            <th>Medium</th>
                            <th>Campaign</th>
                            <th>Content</th>
                            <th>Term</th>
                            <th>í˜ì´ì§€ URL</th>
                            <th>ìµœì¢… URL</th>
                            <th>ë‹¨ì¶• URL</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- ì„¤ì •ê°’ ---
        // const LS_KEY_PREFIX = 'utmGenerator_standalone_'; // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        // const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv';
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1593192047&single=true&output=csv';
        // const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/19P0nk0XDI5HwwkCvZnwGa7C22A-RL6MSzcVx7mjYYRs/edit?gid=663849837&output=csv';
        const N8N_WEBHOOK_URL = 'https://entrench-consulting.app.n8n.cloud/webhook/utm-form'; // <-- ì‚¬ìš©ì ì‹¤ì œ n8n URLë¡œ ë³€ê²½ í•„ìˆ˜!
        // const HISTORY_JSON_URL = 'https://raw.githubusercontent.com/choi-yoonhyuk/source_medium_drop/main/n8n-builder.json'; 
        const GOOGLE_SHEET_HISTORY_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1831366188&single=true&output=csv'; // History ì‹œíŠ¸ì˜ CSV ê²Œì‹œ URLë¡œ ë³€ê²½
        // ì°¸ê³ : ìœ„ URLì€ ì˜ˆì‹œì´ë©°, ì‹¤ì œ History ì‹œíŠ¸ë¥¼ "ì›¹ì— ê²Œì‹œ"í•˜ì—¬ "CSV" í˜•ì‹ìœ¼ë¡œ ìƒì„±ëœ URLì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        // gid=1831366188ëŠ” ë§ì§€ë§Œ, ê·¸ ì•ì˜ /e/2PACX... ë¶€ë¶„ì€ ì‹¤ì œ ê²Œì‹œëœ URLë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.

        const dropdownBaseIds = [
            'source', 'medium', 'ad_type', 'campaign_goal', 'event_type',
            'product_category', 'ad_target', 'creative_type', 'device_type', 'content_action'
        ];

        const columnHeaderMap = {
            'source': 'source', 'medium': 'medium', 'ad_type': 'utm_campaign_ad_type',
            'campaign_goal': 'utm_campaign_goal', 'event_type': 'utm_campaign_event_type',
            'product_category': 'utm_campaign_product_category', 'ad_target': 'utm_campaign_ad_target',
            'creative_type': 'utm_campaign_creative_type', 'device_type': 'utm_campaign_device_type',
            'content_action': 'utm_content_content_action'
        };

        let masterOptionLists = {};

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading("ì˜µì…˜ ë° ì´ë ¥ ë¡œë”© ì¤‘...");
            let csvDataText = null;
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) throw new Error(`ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë¡œë“œ ì‹¤íŒ¨ (${response.status})`);
                csvDataText = await response.text();
                console.log("ë“œë¡­ë‹¤ìš´ ì˜µì…˜ CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ");

                parseAndStoreMasterOptions(csvDataText);

                for (const baseId of dropdownBaseIds) {
                    try {
                        renderDropdownWithOptions(baseId);
                        setupDropdownInteractions(baseId);
                    } catch (error) {
                        console.error(`Error initializing dropdown for ${baseId}:`, error);
                    }
                }
                updateFinalURL();
                await renderHistoryTable();
            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                alert(`ì´ˆê¸° ë°ì´í„°(ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë˜ëŠ” ì´ë ¥)ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) { indicator.textContent = message; indicator.style.display = 'flex'; }
        }
        function hideLoading() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) { indicator.style.display = 'none'; }
        }

        function createOptionLi(value, displayText, type) {
            const li = document.createElement('li');
            const valueForDataset = String(value).trim().toLowerCase();
            li.dataset.value = valueForDataset;
            li.dataset.type = type;

            const iconSpan = document.createElement('span'); iconSpan.className = 'icon'; li.appendChild(iconSpan);
            const textSpan = document.createElement('span'); textSpan.className = 'option-content';
            textSpan.textContent = String(displayText).trim() || String(value).trim();
            li.appendChild(textSpan);

            if (type === 'custom') {
                const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; li.appendChild(deleteBtn);
            }
            return li;
        }

        function parseAndStoreMasterOptions(csvDataText) {
            if (!csvDataText) {
                console.warn("CSV ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ ë§ˆìŠ¤í„° ì˜µì…˜ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                dropdownBaseIds.forEach(baseId => { masterOptionLists[baseId] = new Set(); });
                return;
            }
            try {
                const lines = csvDataText.split(/\r?\n/);
                if (lines.length < 3) {
                    console.warn("CSV ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì˜µì…˜ ë°ì´í„°ëŠ” 3ë²ˆì§¸ ì¤„ë¶€í„° ì‹œì‘).");
                    dropdownBaseIds.forEach(baseId => { masterOptionLists[baseId] = new Set(); });
                    return;
                }
                const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));

                for (const baseId of dropdownBaseIds) {
                    const targetCsvHeader = columnHeaderMap[baseId];
                    if (!targetCsvHeader) {
                        console.warn(`No CSV header mapping for dropdown baseId '${baseId}'.`);
                        masterOptionLists[baseId] = new Set();
                        continue;
                    }

                    const columnIndex = headers.findIndex(header => header === targetCsvHeader);
                    if (columnIndex === -1) {
                        console.warn(`CSVì—ì„œ '${targetCsvHeader}' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (for baseId '${baseId}').`);
                        masterOptionLists[baseId] = new Set();
                        continue;
                    }

                    const optionsForThisCategory = new Set();
                    for (let i = 2; i < lines.length; i++) {
                        const columns = lines[i].split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                        if (columns.length > columnIndex) {
                            const value = String(columns[columnIndex]).trim();
                            if (value && value.toLowerCase() !== 'undefined') { // "undefined" ë¬¸ìì—´ì€ ë§ˆìŠ¤í„° ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€ ì•ˆ í•¨
                                optionsForThisCategory.add(value);
                            }
                        }
                    }
                    masterOptionLists[baseId] = optionsForThisCategory;
                    console.log(`DEBUG: Master options loaded for [${baseId}]:`, Array.from(optionsForThisCategory));
                }
            } catch (error) {
                console.error("Error parsing master options CSV:", error);
                dropdownBaseIds.forEach(baseId => {
                    if (!masterOptionLists[baseId]) masterOptionLists[baseId] = new Set();
                });
            }
        }

        function renderDropdownWithOptions(baseId) {
            const optionsList = document.getElementById(`${baseId}_options_list`);
            const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
            if (!optionsList || !addOptionButton) {
                console.error(`Dropdown elements not found for ${baseId}`);
                return;
            }

            optionsList.innerHTML = '';
            optionsList.appendChild(addOptionButton);

            const defaultOptionsFromMaster = masterOptionLists[baseId] || new Set();
            const allRenderedValuesLowerCase = new Set();

            defaultOptionsFromMaster.forEach(originalValue => {
                const valueTrimmed = String(originalValue).trim();
                const lowerCaseValue = valueTrimmed.toLowerCase();
                if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
                    const li = createOptionLi(valueTrimmed, valueTrimmed, 'default');
                    optionsList.insertBefore(li, addOptionButton);
                    allRenderedValuesLowerCase.add(lowerCaseValue);
                }
            });

            const storageKey = baseId; // LS_KEY_PREFIX ì œê±°, baseIdë¥¼ ì§ì ‘ í‚¤ë¡œ ì‚¬ìš©
            const customValuesFromStorage = JSON.parse(localStorage.getItem(storageKey) || '[]');

            customValuesFromStorage.forEach(originalValueFromStorage => {
                const valueTrimmed = String(originalValueFromStorage).trim();
                const lowerCaseValue = valueTrimmed.toLowerCase();

                if (valueTrimmed && !allRenderedValuesLowerCase.has(lowerCaseValue)) {
                    let isInMasterListAlready = false;
                    defaultOptionsFromMaster.forEach(masterOpt => {
                        if (String(masterOpt).trim().toLowerCase() === lowerCaseValue) {
                            isInMasterListAlready = true;
                        }
                    });

                    if (!isInMasterListAlready) {
                        const li = createOptionLi(valueTrimmed, valueTrimmed, 'custom');
                        optionsList.insertBefore(li, addOptionButton);
                        allRenderedValuesLowerCase.add(lowerCaseValue);
                    }
                }
            });
        }

        function saveCustomOptionsToStorage(baseId) {
            const optionsList = document.getElementById(`${baseId}_options_list`);
            if (!optionsList) {
                console.error(`[saveCustomOptionsToStorage] Options list for ${baseId} not found.`);
                return;
            }
            const storageKey = baseId; // LS_KEY_PREFIX ì œê±°, baseIdë¥¼ ì§ì ‘ í‚¤ë¡œ ì‚¬ìš©

            const customValues = [];
            optionsList.querySelectorAll('li[data-type="custom"]').forEach(li => {
                const contentElement = li.querySelector('.option-content');
                if (contentElement && contentElement.textContent) {
                    customValues.push(contentElement.textContent.trim());
                }
            });
            try {
                localStorage.setItem(storageKey, JSON.stringify(customValues));
                console.log(`[saveCustomOptionsToStorage] Saved custom options for [${baseId}] to localStorage with key [${storageKey}]:`, customValues);
            } catch (e) {
                console.error(`[saveCustomOptionsToStorage] Error saving to localStorage for ${baseId} with key [${storageKey}]:`, e);
                // alert("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì˜µì…˜ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ê°€ í—ˆìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        function setupDropdownInteractions(baseId) {
            const dropdown = document.getElementById(`${baseId}_dropdown`);
            const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
            const optionsList = document.getElementById(`${baseId}_options_list`);
            const hiddenInput = document.getElementById(baseId);
            const addOptionButton = document.getElementById(`${baseId}_add_option_button`);
            const addInputContainer = document.getElementById(`${baseId}_add_input_container`);
            const addInput = document.getElementById(`${baseId}_add_input`);

            if (!dropdown || !selectedValueDiv || !optionsList || !hiddenInput || !addOptionButton || !addInputContainer || !addInput) return;

            selectedValueDiv.addEventListener('click', (event) => {
                event.stopPropagation(); closeOtherDropdowns(baseId); optionsList.classList.toggle('hidden'); addInputContainer.classList.add('hidden');
            });

            optionsList.addEventListener('click', (event) => {
                event.stopPropagation();
                const targetLi = event.target.closest('li');
                if (event.target.classList.contains('delete-btn') && targetLi && targetLi.dataset.type === 'custom') {
                    const textContent = targetLi.querySelector('.option-content')?.textContent || targetLi.dataset.value;
                    if (confirm(`'${textContent}' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¸Œë¼ìš°ì € ì €ì¥ì†Œì—ì„œë§Œ ì‚­ì œë©ë‹ˆë‹¤)`)) {
                        if (hiddenInput.value === targetLi.dataset.value) {
                            selectedValueDiv.textContent = '-- ì„ íƒí•˜ì„¸ìš” --';
                            hiddenInput.value = '';
                        }
                        targetLi.remove();
                        // saveCustomOptionsToStorage(baseId); 
                        updateFinalURL();
                    }
                } else if (targetLi && targetLi.classList.contains('add-option')) {
                    addInputContainer.classList.remove('hidden'); addInput.value = ''; addInput.focus();
                } else if (targetLi && typeof targetLi.dataset.value !== 'undefined') {
                    const value = targetLi.dataset.value;
                    const text = targetLi.querySelector('.option-content')?.textContent || value;
                    selectedValueDiv.textContent = text;
                    hiddenInput.value = value;
                    optionsList.classList.add('hidden');
                    addInputContainer.classList.add('hidden');
                    updateFinalURL();
                }
            });

            addInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const originalNewValue = addInput.value.trim();
                    const lowerCaseNewValue = originalNewValue.toLowerCase();

                    if (!originalNewValue) { alert('ì¶”ê°€í•  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                    if (originalNewValue.toLowerCase() === 'undefined') { // "undefined" ë¬¸ìì—´ ì…ë ¥ ë°©ì§€
                        alert("'undefined'ë¼ëŠ” ê°’ì€ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        addInput.value = '';
                        return;
                    }
                    if (/\s|&|\?|#|\.|\/|\\/.test(originalNewValue)) { alert("ë„ì–´ì“°ê¸° ë° íŠ¹ìˆ˜ë¬¸ì(&, ?, #, ., /, \\)ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
                    if (/[^a-z0-9_\-]/.test(lowerCaseNewValue)) { alert("Key ê°’(ì†Œë¬¸ìë¡œ ë³€í™˜ëœ ê°’)ì€ ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´(_), í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }

                    let existsInCurrentDropdown = false;
                    optionsList.querySelectorAll('li[data-value]').forEach(li => { if (li.dataset.value === lowerCaseNewValue) existsInCurrentDropdown = true; });
                    if (existsInCurrentDropdown) { alert("ì´ë¯¸ í˜„ì¬ ë“œë¡­ë‹¤ìš´ ëª©ë¡ì— ì¡´ì¬í•˜ëŠ” ê°’ì…ë‹ˆë‹¤ (ì†Œë¬¸ì ê¸°ì¤€)."); return; }

                    const newLi = createOptionLi(originalNewValue, originalNewValue, 'custom');
                    optionsList.insertBefore(newLi, addOptionButton);
                    // saveCustomOptionsToStorage(baseId); 

                    console.log(`ìƒˆ ì˜µì…˜ '${originalNewValue}'ì€(ëŠ”) ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                    selectedValueDiv.textContent = originalNewValue;
                    hiddenInput.value = lowerCaseNewValue;
                    addInputContainer.classList.add('hidden');
                    optionsList.classList.add('hidden');
                    updateFinalURL();
                }
            });
            addInput.addEventListener('blur', () => {
                setTimeout(() => { if (!addInputContainer.contains(document.activeElement)) { addInputContainer.classList.add('hidden'); } }, 150);
            });
        }

        function closeOtherDropdowns(currentBaseId) {
            dropdownBaseIds.forEach(baseId => {
                if (baseId !== currentBaseId) {
                    document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
                    document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
                }
            });
        }
        document.addEventListener('click', (event) => {
            dropdownBaseIds.forEach(baseId => {
                const dropdownElement = document.getElementById(`${baseId}_dropdown`);
                if (dropdownElement && !dropdownElement.contains(event.target)) {
                    document.getElementById(`${baseId}_options_list`)?.classList.add('hidden');
                    document.getElementById(`${baseId}_add_input_container`)?.classList.add('hidden');
                }
            });
        });

        function getValueOrN(elementId) {
            const element = document.getElementById(elementId);
            let value = "";
            if (element) { // text input ë˜ëŠ” hidden input
                value = element.value.trim();
            }

            const selectedDisplayElement = document.getElementById(`${elementId}_selected_value`); // ë“œë¡­ë‹¤ìš´ì˜ ê²½ìš°ì—ë§Œ ì¡´ì¬
            if (selectedDisplayElement && selectedDisplayElement.textContent.trim() === "-- ì„ íƒí•˜ì„¸ìš” --") {
                return "n";
            }
            if (value === "" || value.toLowerCase() === "n") { // ì§ì ‘ ì…ë ¥ í•„ë“œê°€ ë¹„ì—ˆê±°ë‚˜, hidden inputì´ "n"ì´ê±°ë‚˜ ë¹„ì—ˆìœ¼ë©´
                return "n";
            }
            return value.toLowerCase(); // ìµœì¢…ì ìœ¼ë¡œ ì†Œë¬¸ìí™”ëœ ê°’ (ë˜ëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ê°’ì˜ ì†Œë¬¸ì)
        }

        function updateFinalURL() {
            const pageUrl = document.getElementById("page_url").value.trim();
            const utmSource = getValueOrN("source");
            const utmMedium = getValueOrN("medium");
            const campaignDate = getValueOrN("campaign_date");
            const adType = getValueOrN("ad_type");
            const campaignGoal = getValueOrN("campaign_goal");
            const eventType = getValueOrN("event_type");
            const productCategory = getValueOrN("product_category");
            const adTarget = getValueOrN("ad_target");
            const creativeType = getValueOrN("creative_type");
            const deviceType = getValueOrN("device_type");

            const utmCampaignParts = [
                campaignDate, adType, campaignGoal, eventType,
                productCategory, adTarget, creativeType, deviceType
            ];
            const utmCampaign = utmCampaignParts.map(part => part === "n" ? "N" : part).join("_");
            document.getElementById("utm_campaign").value = utmCampaign;

            const contentAction = getValueOrN("content_action");
            const contentDetail = getValueOrN("content_detail");
            const contentVersion = getValueOrN("content_version");

            const utmContentParts = [contentAction, contentDetail, contentVersion].map(part => part === "n" ? "N" : part);
            const utmContent = utmContentParts.every(part => part === "N") ? "N" : utmContentParts.join("_");
            document.getElementById("utm_content").value = utmContent;

            const utmTerm = getValueOrN("utm_term");

            let finalURLGenerated = pageUrl;
            if (!pageUrl) {
                document.getElementById("final_url").value = "";
                return;
            }
            const params = [];
            if (utmSource && utmSource !== "n") params.push(`utm_source=${encodeURIComponent(utmSource)}`);
            if (utmMedium && utmMedium !== "n") params.push(`utm_medium=${encodeURIComponent(utmMedium)}`);

            const defaultCampaign = Array(utmCampaignParts.length).fill("N").join("_");
            if (utmCampaign && utmCampaign !== defaultCampaign) {
                params.push(`utm_campaign=${encodeURIComponent(utmCampaign)}`);
            }

            const defaultContent = "N_N_N";
            if (utmContent && utmContent !== "N" && utmContent !== defaultContent) {
                params.push(`utm_content=${encodeURIComponent(utmContent)}`);
            }
            if (utmTerm && utmTerm !== "n") params.push(`utm_term=${encodeURIComponent(utmTerm)}`);

            if (params.length > 0) {
                finalURLGenerated += (pageUrl.includes('?') ? '&' : '?') + params.join('&');
            }
            document.getElementById("final_url").value = finalURLGenerated;
        }

        async function fetchHistoryData() {
            showLoading("ì´ë ¥ ë¡œë”© ì¤‘ (Google Sheet)...");
            try {
                const response = await fetch(GOOGLE_SHEET_HISTORY_URL); // ìƒˆë¡œìš´ URL ì‚¬ìš©
                if (!response.ok) {
                    console.warn(`Google Sheet íˆìŠ¤í† ë¦¬(${GOOGLE_SHEET_HISTORY_URL}) ì—†ìŒ ë˜ëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:`, response.status, response.statusText);
                    hideLoading();
                    return [];
                }
                const csvText = await response.text();
                if (!csvText) {
                    console.warn(`Google Sheet íˆìŠ¤í† ë¦¬(${GOOGLE_SHEET_HISTORY_URL}) ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
                    hideLoading();
                    return [];
                }

                // CSV íŒŒì‹± (ê¸°ì¡´ n8n JSONì˜ history ì‹œíŠ¸ ì»¬ëŸ¼ëª…ì— ë§ì¶°ì•¼ í•¨)
                const lines = csvText.split(/\r?\n/);
                if (lines.length < 2) { // í—¤ë” + ë°ì´í„° ìµœì†Œ 1ì¤„
                    console.warn("Google Sheet íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    hideLoading();
                    return [];
                }
                const headers = lines[0].split(',').map(h => String(h).trim().replace(/^"|"$/g, ''));
                const historyData = [];

                // History ì‹œíŠ¸ì˜ ì»¬ëŸ¼ëª…ì— ë§ì¶° ì¸ë±ìŠ¤ ì°¾ê¸°
                const createdAtIdx = headers.indexOf('ìƒì„±ì¼ì‹œ'); // ì‹¤ì œ ì‹œíŠ¸ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ë³€ê²½
                const sourceIdx = headers.indexOf('Source');
                const mediumIdx = headers.indexOf('Medium');
                const campaignIdx = headers.indexOf('Campaign');
                const contentIdx = headers.indexOf('Content');
                const termIdx = headers.indexOf('Term');
                const pageUrlIdx = headers.indexOf('í˜ì´ì§€ URL');
                const finalUrlIdx = headers.indexOf('ìµœì¢… URL');
                const shortUrlIdx = headers.indexOf('ë‹¨ì¶• URL');

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;
                    const columns = lines[i].split(',').map(s => String(s).trim().replace(/^"|"$/g, ''));
                    const entry = {};
                    if (createdAtIdx > -1) entry.timestamp = columns[createdAtIdx]; // 'timestamp' í‚¤ë¡œ í†µì¼
                    if (sourceIdx > -1) entry.utm_source = columns[sourceIdx];
                    if (mediumIdx > -1) entry.utm_medium = columns[mediumIdx];
                    if (campaignIdx > -1) entry.utm_campaign_combined = columns[campaignIdx];
                    if (contentIdx > -1) entry.utm_content_combined = columns[contentIdx];
                    if (termIdx > -1) entry.utm_term = columns[termIdx];
                    if (pageUrlIdx > -1) entry.page_url = columns[pageUrlIdx];
                    if (finalUrlIdx > -1) entry.final_url = columns[finalUrlIdx];
                    if (shortUrlIdx > -1) entry.short_url = columns[shortUrlIdx];
                    historyData.push(entry);
                }

                // ì •ë ¬ ë¡œì§ (timestamp ê¸°ì¤€)
                return historyData.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return (isNaN(dateB.getTime()) ? 0 : dateB.getTime()) - (isNaN(dateA.getTime()) ? 0 : dateA.getTime());
                });

            } catch (error) {
                console.warn(`Google Sheet íˆìŠ¤í† ë¦¬(${GOOGLE_SHEET_HISTORY_URL}) ë¡œë”© ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨:`, error);
                return [];
            } finally {
                hideLoading();
            }
        }
        // async function fetchHistoryData() { 
        //     try {
        //         const response = await fetch(HISTORY_JSON_URL);
        //         if (!response.ok) {
        //             console.warn(`íˆìŠ¤í† ë¦¬ íŒŒì¼(${HISTORY_JSON_URL}) ì—†ìŒ ë˜ëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:`, response.status, response.statusText);
        //             return []; 
        //         }
        //         const responseText = await response.text(); 
        //         if (!responseText) {
        //             console.warn(`íˆìŠ¤í† ë¦¬ íŒŒì¼(${HISTORY_JSON_URL}) ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
        //             return []; 
        //         }
        //         const data = JSON.parse(responseText); 
        //         if (!Array.isArray(data)) {
        //             console.warn(`íˆìŠ¤í† ë¦¬ ë°ì´í„°(${HISTORY_JSON_URL}) í˜•ì‹ ì˜¤ë¥˜. ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤. ì‹¤ì œ ë‚´ìš©:`, data);
        //             return []; 
        //         }
        //         return data.sort((a, b) => {
        //             const timeA = a?.timestamp || (a?.formData && a.formData.timestamp) || 0;
        //             const timeB = b?.timestamp || (b?.formData && b.formData.timestamp) || 0;
        //             const dateA = new Date(timeA);
        //             const dateB = new Date(timeB);
        //             const valA = !isNaN(dateA.getTime()) ? dateA.getTime() : 0;
        //             const valB = !isNaN(dateB.getTime()) ? dateB.getTime() : 0;
        //             return valB - valA; 
        //         });
        //     } catch (error) {
        //         console.warn(`íˆìŠ¤í† ë¦¬ ë°ì´í„°(${HISTORY_JSON_URL}) ë¡œë”© ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨:`, error);
        //         return []; 
        //     }
        // }
        async function renderHistoryTable() {
            const tableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
            if (!tableBody) { console.error("History table body (tbody) ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; }
            tableBody.innerHTML = '';

            showLoading("ì´ë ¥ ë¡œë”© ì¤‘...");
            let historyData;
            try {
                historyData = await fetchHistoryData();
            } catch (fetchError) {
                console.error("fetchHistoryData í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", fetchError);
                historyData = [];
            }
            hideLoading();

            if (!Array.isArray(historyData) || historyData.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 9;
                cell.textContent = 'í‘œì‹œí•  ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                cell.style.textAlign = 'center';
                return;
            }

            historyData.forEach(item => {
                const row = tableBody.insertRow();
                let displayTimestamp = 'N/A';
                const itemTimestamp = item?.timestamp || (item?.formData && item.formData.timestamp);
                if (itemTimestamp) {
                    try {
                        displayTimestamp = new Date(itemTimestamp).toLocaleString('ko-KR', { dateStyle: 'short', timeStyle: 'short' });
                    } catch (e) { console.warn("Error parsing timestamp for history: ", itemTimestamp, e); }
                }
                row.insertCell().textContent = displayTimestamp;
                row.insertCell().textContent = item?.utm_source || (item?.formData?.utm_source) || 'N';
                row.insertCell().textContent = item?.utm_medium || (item?.formData?.utm_medium) || 'N';
                row.insertCell().textContent = item?.utm_campaign_combined || (item?.formData?.utm_campaign_combined) || 'N';
                row.insertCell().textContent = item?.utm_content_combined || (item?.formData?.utm_content_combined) || 'N';
                row.insertCell().textContent = item?.utm_term || (item?.formData?.utm_term) || 'N';

                const pageUrlCell = row.insertCell();
                const originalPageUrl = item?.page_url || (item?.formData && item.formData.page_url) || '';
                pageUrlCell.textContent = originalPageUrl;
                pageUrlCell.title = originalPageUrl;
                pageUrlCell.style.cssText = 'max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';

                const finalUrlCell = row.insertCell();
                const finalUrl = item?.final_url || (item?.formData && item.formData.final_url) || '';
                finalUrlCell.textContent = finalUrl;
                finalUrlCell.title = finalUrl;
                finalUrlCell.style.cssText = 'max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';

                const shortUrlCell = row.insertCell();
                const shortUrl = item?.short_url || '';
                shortUrlCell.textContent = shortUrl || 'N/A';
                shortUrlCell.title = shortUrl;
                shortUrlCell.style.cssText = 'max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            });
        }
        function copyLink() {
            const input = document.getElementById("shortUrlInput");
            if (!input || !input.value) {
                alert("ë³µì‚¬í•  ë‹¨ì¶• URLì´ ì—†ìŠµë‹ˆë‹¤."); return;
            }
            input.select(); input.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand("copy");
                if (successful) { alert("âœ… ë‹¨ì¶• URL ë³µì‚¬ ì™„ë£Œ!"); }
                else { alert("âŒ ë‹¨ì¶• URL ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”."); }
            } catch (err) {
                alert("âŒ ë³µì‚¬ ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); console.error('Copy error', err);
            }
            if (window.getSelection) { window.getSelection().removeAllRanges(); }
            else if (document.selection) { document.selection.empty(); }
        }

        // ===================================================================================
        // === í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•µì‹¬ ë¡œì§: ë§ˆìŠ¤í„° ì˜µì…˜ ì¤‘ë³µ í™•ì¸ ë° n8n ë°ì´í„° êµ¬ì„±) ===
        // ===================================================================================
        // index.html ë‚´ ì²« ë²ˆì§¸(ì£¼ìš”) submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById("utmForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            showLoading("UTM ë§í¬ ìƒì„± ë° ì „ì†¡ ì¤‘...");

            // 1. í•„ìˆ˜ í•­ëª© ìœ íš¨ì„± ê²€ì‚¬ (getValueOrN ì‚¬ìš©)
            const requiredFieldsCheck = [
                { id: "page_url", name: "Page URL" }, { id: "source", name: "UTM Source" },
                { id: "medium", name: "UTM Medium" }, { id: "campaign_date", name: "ë‚ ì§œ" },
                { id: "ad_type", name: "ê´‘ê³ íƒ€ì…" }, { id: "device_type", name: "ê¸°ê¸°ì¹´í…Œê³ ë¦¬" }
            ];

            for (let field of requiredFieldsCheck) {
                // getValueOrNì€ hidden inputì˜ ì†Œë¬¸ìí™”ëœ ê°’ì„ ê°€ì ¸ì˜¤ê±°ë‚˜, "-- ì„ íƒí•˜ì„¸ìš” --"ì¼ ê²½ìš° "n"ì„ ë°˜í™˜.
                // í˜ì´ì§€ URL, ë‚ ì§œ ë“± ì§ì ‘ ì…ë ¥ í•„ë“œëŠ” í•´ë‹¹ inputì˜ ê°’ì„ ì§ì ‘ í™•ì¸í•´ì•¼ í•¨.
                let valueToCheck;
                if (document.getElementById(field.id).tagName === 'INPUT' && document.getElementById(field.id).type === 'text') {
                    valueToCheck = document.getElementById(field.id).value.trim();
                } else { // ë“œë¡­ë‹¤ìš´ì˜ hidden input
                    valueToCheck = getValueOrN(field.id);
                }

                if (valueToCheck === "" || valueToCheck === "n") {
                    alert(`í•„ìˆ˜ í•­ëª© '${field.name}'ì„(ë¥¼) ì„ íƒ ë˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    hideLoading();
                    const elementToFocus = document.getElementById(field.id);
                    if (document.getElementById(`${field.id}_dropdown`)) {
                        document.getElementById(`${field.id}_selected_value`)?.focus(); // ë“œë¡­ë‹¤ìš´ ì„ íƒì°½ì— í¬ì»¤ìŠ¤
                    } else {
                        elementToFocus?.focus();
                    }
                    return;
                }
            }

            // 2. ìµœì¢… URL ë° ì¡°í•©ëœ ìº í˜ì¸/ì½˜í…ì¸  ê°’ ì—…ë°ì´íŠ¸
            updateFinalURL(); // ì´ í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ getValueOrNì„ ì‚¬ìš©í•˜ì—¬ hidden input ê°’ì„ ì°¸ì¡°

            // 3. n8nìœ¼ë¡œ ì „ì†¡í•  ìµœì¢… ë°ì´í„° ê°ì²´ êµ¬ì„±
            const formDataForN8n = {
                page_url: document.getElementById('page_url').value.trim(),
                utm_campaign_combined: document.getElementById('utm_campaign').value.trim(),
                utm_content_combined: document.getElementById('utm_content').value.trim(),
                final_url: document.getElementById('final_url').value.trim(), // ìµœì¢… ìƒì„±ëœ URL (UTM íŒŒë¼ë¯¸í„° í¬í•¨)
                timestamp: new Date().toISOString()
            };

            // ê° UTM íŒŒë¼ë¯¸í„°ì˜ ìµœì¢… ì„ íƒ/ì…ë ¥ëœ ê°’ (ì†Œë¬¸ìí™”ëœ key ê°’)ì„ formDataForN8nì— ì¶”ê°€
            // parametersToLog ë°°ì—´ì€ keyForN8nì„ ì •ì˜í•˜ì—¬, Map Fields ë…¸ë“œê°€ ì´ í‚¤ë“¤ì„ ì‚¬ìš©í•˜ê²Œ í•¨.
            const parametersToLog = [
                { id: 'source', keyForN8n: 'utm_source' }, { id: 'medium', keyForN8n: 'utm_medium' },
                { id: 'campaign_date', keyForN8n: 'campaign_date' }, // ì§ì ‘ ì…ë ¥ ê°’
                { id: 'ad_type', keyForN8n: 'ad_type' },
                { id: 'campaign_goal', keyForN8n: 'campaign_goal' },
                { id: 'event_type', keyForN8n: 'event_type' },
                { id: 'product_category', keyForN8n: 'product_category' },
                { id: 'ad_target', keyForN8n: 'ad_target' },
                { id: 'creative_type', keyForN8n: 'creative_type' },
                { id: 'device_type', keyForN8n: 'device_type' },
                { id: 'content_action', keyForN8n: 'content_action' },
                { id: 'content_detail', keyForN8n: 'content_detail' },     // ì§ì ‘ ì…ë ¥ ê°’
                { id: 'content_version', keyForN8n: 'content_version' }, // ì§ì ‘ ì…ë ¥ ê°’
                { id: 'utm_term', keyForN8n: 'utm_term' }                 // ì§ì ‘ ì…ë ¥ ê°’
            ];

            for (const param of parametersToLog) {
                let elementValue;
                const inputElement = document.getElementById(param.id);
                // ì§ì ‘ ì…ë ¥ í•„ë“œ (text input) ì™€ ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ (hidden input) êµ¬ë¶„
                if (inputElement.name.endsWith('_form')) { // ì˜ˆ: campaign_date_form, content_detail_form ë“±
                    elementValue = inputElement.value.trim(); // ì›ë³¸ í…ìŠ¤íŠ¸ ê°’ ì‚¬ìš© (í•„ìš”ì‹œ ì†Œë¬¸ìí™”)
                    if (!elementValue) elementValue = "n"; // ë¹ˆ ê°’ì€ "n"ìœ¼ë¡œ ì²˜ë¦¬
                } else { // ë“œë¡­ë‹¤ìš´ (hidden input ì‚¬ìš©)
                    elementValue = getValueOrN(param.id); // getValueOrNì€ ì´ë¯¸ ì†Œë¬¸ìí™” ë° "n" ì²˜ë¦¬
                }

                // Current logic: only adds if not "n"
                // if (elementValue !== "n") { 
                //     formDataForN8n[param.keyForN8n] = elementValue;
                // }

                // === MODIFICATION START ===
                // Modified logic: always add the parameter, even if its value is "n"
                formDataForN8n[param.keyForN8n] = elementValue;
                // === MODIFICATION END ===
            }
            // ...

            // "params" (ì˜µì…˜ ë§ˆìŠ¤í„°) ì‹œíŠ¸ì— ì¶”ê°€í•  "ìƒˆë¡œìš´" ì˜µì…˜ ê°’ë“¤ë§Œ ì‹ë³„
            const optionsForMasterUpdate = {};
            console.log("--- Identifying new options to add to master sheet (Submit Event) ---");
            for (const baseId of dropdownBaseIds) { // dropdownBaseIds: ë“œë¡­ë‹¤ìš´ì˜ ê¸°ë³¸ ID ëª©ë¡
                const selectedValueDisplayElement = document.getElementById(`${baseId}_selected_value`); // í™”ë©´ í‘œì‹œ í…ìŠ¤íŠ¸
                // const hiddenInputElement = document.getElementById(baseId); // ì‹¤ì œ ì„ íƒëœ key ê°’ (ì†Œë¬¸ì)

                if (selectedValueDisplayElement) {
                    const selectedValueDisplayText = selectedValueDisplayElement.textContent.trim(); // í™”ë©´ì— í‘œì‹œëœ ì›ë³¸ ê°’

                    if (selectedValueDisplayText && selectedValueDisplayText.toLowerCase() !== "n" && selectedValueDisplayText !== "-- ì„ íƒí•˜ì„¸ìš” --" && selectedValueDisplayText.toLowerCase() !== "undefined") {
                        const masterListForThisCategory = masterOptionLists[baseId] || new Set();
                        let isNewForMaster = true;
                        const lowercasedSelectedDisplayText = selectedValueDisplayText.toLowerCase();

                        if (masterListForThisCategory.size > 0) {
                            for (const masterOption of masterListForThisCategory) {
                                if (String(masterOption).trim().toLowerCase() === lowercasedSelectedDisplayText) {
                                    isNewForMaster = false;
                                    break;
                                }
                            }
                        }
                        if (isNewForMaster) {
                            // n8nìœ¼ë¡œ ë³´ë‚¼ ë•ŒëŠ” Map Fieldsì˜ í‚¤ì™€ ë§ì¶”ê¸° ìœ„í•´ baseIdë¥¼ ì‚¬ìš©
                            // ì˜ˆ: optionsForMasterUpdate['utm_source'] = 'ìƒˆë¡œìš´ì†ŒìŠ¤ëª…'
                            // ì‹¤ì œ CSV ì»¬ëŸ¼ëª…ê³¼ì˜ ë§¤í•‘ì€ n8nì˜ Format to Update Sheet ë…¸ë“œì—ì„œ ì²˜ë¦¬
                            const keyForN8n = parametersToLog.find(p => p.id === baseId)?.keyForN8n || baseId;
                            optionsForMasterUpdate[keyForN8n] = selectedValueDisplayText; // ì›ë³¸ í…ìŠ¤íŠ¸ ê°’ ì „ì†¡
                        }
                    }
                }
            }
            if (Object.keys(optionsForMasterUpdate).length > 0) {
                formDataForN8n.options_to_add_to_master_sheet = optionsForMasterUpdate;
            }
            console.log("--- ìµœì¢… formDataForN8n (to be sent to n8n):", formDataForN8n, " ---");


            // 4. n8nìœ¼ë¡œ ë°ì´í„° ì „ì†¡ ë° ì‘ë‹µ ì²˜ë¦¬
            try {
                const n8nUrl = N8N_WEBHOOK_URL; // Production URL ì‚¬ìš© ì¤‘

                // URL ìœ íš¨ì„± ê²€ì‚¬ (localhost HTTPS ê²½ê³ ë§Œ ë‚¨ê¸°ê±°ë‚˜, í•„ìš”ì— ë”°ë¼ ë‹¨ìˆœí™”)
                if (!n8nUrl) {
                    alert("n8n ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ ì•ˆë¨):\n" + formDataForN8n.final_url);
                    hideLoading();
                    return;
                }
                if (n8nUrl.startsWith('http://localhost') && window.location.protocol === 'https:') {
                    alert("ê²½ê³ : í˜„ì¬ í˜ì´ì§€ëŠ” HTTPSì´ë‚˜ n8n ì›¹í›…ì€ HTTP ë¡œì»¬í˜¸ìŠ¤íŠ¸ì…ë‹ˆë‹¤...\nUTM ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ ì•ˆë¨):\n" + formDataForN8n.final_url);
                    hideLoading();
                    return;
                }

                const res = await fetch(n8nUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formDataForN8n)
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`n8n ì›¹í›… ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText || res.statusText}`);
                }

                const result = await res.json(); // n8nì˜ "Respond to Webhook" ë…¸ë“œê°€ ë³´ë‚´ëŠ” JSON ì‘ë‹µ
                console.log("Response from n8n:", result);

                // HTML ì¡°ê° ì‚½ì… (ë‘ ë²ˆì§¸ ë¦¬ìŠ¤ë„ˆì˜ ê¸°ëŠ¥ í†µí•©)
                const formElement = document.getElementById('utmForm');
                const responseContainerDiv = document.getElementById("responseContainer");
                const shortUrlInputEl = document.getElementById("shortUrlInput");

                // shortUrlHtml ì²˜ë¦¬
                if (result.shortUrlHtml && formElement) {
                    // ê¸°ì¡´ shortUrlContainerê°€ ìˆë‹¤ë©´ ë‚´ìš©ë§Œ êµì²´, ì—†ë‹¤ë©´ form ë’¤ì— ì‚½ì…
                    let shortUrlDisplayDiv = document.getElementById('shortUrlContainer');
                    if (!shortUrlDisplayDiv) {
                        shortUrlDisplayDiv = document.createElement('div');
                        shortUrlDisplayDiv.id = 'shortUrlContainer';
                        formElement.insertAdjacentElement('afterend', shortUrlDisplayDiv); // form ë‹¤ìŒì— ì‚½ì…
                    }
                    shortUrlDisplayDiv.innerHTML = result.shortUrlHtml;

                    // ì¶”ê°€ì ìœ¼ë¡œ #responseContainerì˜ inputì—ë„ ê°’ì„ ì±„ì›Œë„£ì„ ìˆ˜ ìˆìŒ
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = result.shortUrlHtml;
                    const shortUrlFromHtml = tempDiv.querySelector('#shortUrlOutput')?.value || tempDiv.querySelector('#shortUrl')?.value;
                    if (shortUrlInputEl && shortUrlFromHtml) {
                        shortUrlInputEl.value = shortUrlFromHtml;
                    }
                    if (responseContainerDiv) responseContainerDiv.style.display = "block";

                } else if (result.short_url && shortUrlInputEl) { // short_url í‚¤ë§Œ ì˜¤ëŠ” ê²½ìš°
                    shortUrlInputEl.value = result.short_url;
                    if (responseContainerDiv) responseContainerDiv.style.display = "block";
                } else {
                    console.warn("n8n ì‘ë‹µì— shortUrlHtml ë˜ëŠ” short_url í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    if (responseContainerDiv) responseContainerDiv.style.display = "none";
                }

                // ì´ë ¥ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (newTableBodyHtml ë˜ëŠ” newRowHtml ì‚¬ìš©)
                const historyTableBody = document.getElementById('historyTable')?.getElementsByTagName('tbody')[0];
                if (historyTableBody) {
                    if (result.newTableBodyHtml) { // ì „ì²´ tbodyë¥¼ êµì²´ (n8nì—ì„œ ëª¨ë“  í–‰ì„ ë‹¤ì‹œ ë§Œë“¤ì–´ ë³´ë‚´ëŠ” ê²½ìš°)
                        historyTableBody.innerHTML = result.newTableBodyHtml;
                    }
                    // ë§Œì•½ n8nì—ì„œ ìƒˆ í–‰ í•˜ë‚˜ë§Œ ë³´ë‚´ê³  í”„ë¡ íŠ¸ì—ì„œ ì¶”ê°€í•˜ëŠ” ë¡œì§ì„ ì›í•œë‹¤ë©´,
                    // result.newSingleRowHtml (ì˜ˆì‹œ) ê°™ì€ í‚¤ë¡œ ë°›ê³  ì•„ë˜ì²˜ëŸ¼ ì¶”ê°€:
                    // else if (result.newSingleRowHtml) {
                    // historyTableBody.insertAdjacentHTML('afterbegin', result.newSingleRowHtml); // ë§¨ ìœ„ì— ì¶”ê°€
                    // }
                }

                if (result.shortUrlHtml || result.short_url) {
                    alert("UTM ë§í¬ ìƒì„±, ë‹¨ì¶• ë° ì‹œíŠ¸ ì €ì¥ ìš”ì²­ ì™„ë£Œ!");
                } else {
                    alert("ë‹¨ì¶• URLì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš° ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.\n(ì‹œíŠ¸ ì €ì¥ì€ ì‹œë„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: " + formDataForN8n.final_url);
                }

            } catch (err) {
                console.error("n8n ì „ì†¡ ë˜ëŠ” ì²˜ë¦¬ ì˜¤ë¥˜:", err);
                alert(`ì„œë²„ í†µì‹  ë˜ëŠ” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}\n(UTM ë§í¬ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ë‹¨ì¶• ë° ì´ë ¥/ì‹œíŠ¸ ì €ì¥ì€ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)\nìµœì¢… URL: ${formDataForN8n.final_url}`);
                document.getElementById("responseContainer").style.display = "none";
            } finally {
                hideLoading();
                await renderHistoryTable(); // í•­ìƒ ìµœì‹  ì´ë ¥ìœ¼ë¡œ í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¼
                document.getElementById("utmForm").reset();
                // ë“œë¡­ë‹¤ìš´ ê¸°ë³¸ê°’ ì¬ì„¤ì • ë° ìµœì¢… URL í•„ë“œ ì—…ë°ì´íŠ¸
                dropdownBaseIds.forEach(baseId => { // í•„ìˆ˜ í•­ëª© ê¸°ë³¸ê°’ ì¬ì„¤ì •
                    if (baseId === 'source') setSelectedDropdownValue(baseId, 'google');
                    else if (baseId === 'medium') setSelectedDropdownValue(baseId, 'cpc');
                    else if (baseId === 'ad_type') setSelectedDropdownValue(baseId, 'da');
                    else if (baseId === 'device_type') setSelectedDropdownValue(baseId, 'mo');
                    else setSelectedDropdownValue(baseId, ''); // ë‚˜ë¨¸ì§€ ì„ íƒì  í•­ëª©ì€ '-- ì„ íƒí•˜ì„¸ìš” --'
                });
                updateFinalURL();
            }
        });

        // ë“œë¡­ë‹¤ìš´ ê°’ì„ ì„¤ì •í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
        function setSelectedDropdownValue(baseId, valueToSet) {
            const selectedValueDiv = document.getElementById(`${baseId}_selected_value`);
            const hiddenInput = document.getElementById(baseId);
            const optionsList = document.getElementById(`${baseId}_options_list`);

            if (!selectedValueDiv || !hiddenInput || !optionsList) return;

            if (valueToSet === '') { // "-- ì„ íƒí•˜ì„¸ìš” --" ë¡œ ì´ˆê¸°í™”
                selectedValueDiv.textContent = '-- ì„ íƒí•˜ì„¸ìš” --';
                hiddenInput.value = '';
                return;
            }

            let optionFound = false;
            optionsList.querySelectorAll('li[data-value]').forEach(li => {
                if (li.dataset.value === valueToSet.toLowerCase()) {
                    selectedValueDiv.textContent = li.querySelector('.option-content')?.textContent || valueToSet;
                    hiddenInput.value = li.dataset.value;
                    optionFound = true;
                }
            });
            if (!optionFound) { // ì˜µì…˜ ëª©ë¡ì— ì—†ëŠ” ê°’ì´ë¼ë©´ (ì˜ˆ: ì´ˆê¸°í™” ì‹œ ê¸°ë³¸ê°’)
                selectedValueDiv.textContent = valueToSet; // í‘œì‹œ í…ìŠ¤íŠ¸ë§Œì´ë¼ë„ ì„¤ì •
                hiddenInput.value = valueToSet.toLowerCase();
            }
        }
    </script>
    <!-- <script>
  document.getElementById('utmForm').addEventListener('submit', async function(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');

      const result = await response.json();

      // ë§Œì•½ ì´ë¯¸ shortUrlContainerê°€ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
      const existingShortUrl = document.getElementById('shortUrlContainer');
      if (existingShortUrl) {
        existingShortUrl.remove();
      }

      // shortUrlContainerë¥¼ form ë°”ë¡œ ë’¤ì— ì‚½ì…
      form.insertAdjacentHTML('beforeend', result.shortUrlHtml);

      // ì´ë ¥ í…Œì´ë¸”ì— ìƒˆë¡œìš´ row ì¶”ê°€
      document.querySelector('#historyTableContainer tbody').insertAdjacentHTML('beforeend', result.newRowHtml);

      // í¼ ë¦¬ì…‹
      form.reset();
    } catch (error) {
      console.error('í¼ ì œì¶œ ì‹¤íŒ¨:', error);
    }
  });
</script> -->

</body>

</html>